import React, { useState, useEffect } from 'react';
import { getAgreements, getSites, getCompanies, getTransactions } from '../services/api';
import { getUser } from '../utils/auth';
import { useNavigate } from 'react-router-dom';

// Import helper functions
const AgreementHelpers = ({
  companies = [],
  sites = [],
  agreements = [],
  sitePanelSelections = {},
  selectedWeeks = [],
  formData = {}
}) => {
  // Get company name by ID
  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  // Get site name by ID
  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount);
  };

  // Check if two date ranges overlap
  const dateRangesOverlap = (start1, end1, start2, end2) => {
    return start1 <= end2 && start2 <= end1;
  };

  // Generate block labels (A, B, C, etc.)
  const generateBlockLabels = (blockCount) => {
    const labels = [];
    for (let i = 0; i < blockCount; i++) {
      labels.push(String.fromCharCode(65 + i)); // A, B, C, etc.
    }
    return labels;
  };

  // Get information about which agreement is using a specific panel
  const getPanelUsageInfo = (siteId, blockId, panelId, startDate, endDate) => {
    if (!startDate || !endDate) return null;
    
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId) &&
      agreement.status === 'active'
    );
    
    const newStart = new Date(startDate);
    const newEnd = new Date(endDate);
    
    for (const agreement of siteAgreements) {
      const existingStart = new Date(agreement.startDate);
      const existingEnd = new Date(agreement.endDate);
      
      if (dateRangesOverlap(newStart, newEnd, existingStart, existingEnd)) {
        if (agreement.siteBlockSelections && agreement.siteBlockSelections[siteId]) {
          const usedBlocks = agreement.siteBlockSelections[siteId];
          if (usedBlocks.includes(blockId)) {
            if (agreement.sitePanelSelections && 
                agreement.sitePanelSelections[siteId] && 
                agreement.sitePanelSelections[siteId][blockId] &&
                agreement.sitePanelSelections[siteId][blockId].includes(panelId)) {
              return {
                agreementId: agreement.id,
                companyName: getCompanyName(agreement.companyId),
                startDate: agreement.startDate,
                endDate: agreement.endDate
              };
            }
          }
        }
      }
    }
    
    return null;
  };

  return {
    getCompanyName,
    getSiteName,
    formatCurrency,
    dateRangesOverlap,
    generateBlockLabels,
    getPanelUsageInfo
  };
};

const CompanyDashboard = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [company, setCompany] = useState(null);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    totalAgreements: 0,
    activeAgreements: 0,
    totalSites: 0,
    totalPanels: 0,
    totalRevenue: 0
  });
  const [transactions, setTransactions] = useState([]); // Add transactions state
  const [showAgreementHistory, setShowAgreementHistory] = useState(false);
  const [selectedDate, setSelectedDate] = useState('');
  const [filteredAgreements, setFilteredAgreements] = useState([]);
  const navigate = useNavigate();
  
  const user = getUser();
  const companyId = user?.companyId || user?.id;

  useEffect(() => {
    const fetchData = async () => {
      if (!companyId) {
        navigate('/');
        return;
      }

      try {
        const [allAgreements, allSites, allCompanies, allTransactions] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies(),
          getTransactions()
        ]);
        
        // Filter agreements for this company
        const companyAgreements = allAgreements.filter(agreement => 
          String(agreement.companyId) === String(companyId)
        );
        
        // Get company information
        const companyInfo = allCompanies.find(c => String(c.id) === String(companyId)) || null;
        
        setAgreements(companyAgreements);
        setSites(allSites);
        setCompany(companyInfo);
        setTransactions(allTransactions); // Set transactions
        setFilteredAgreements(companyAgreements);
        
        // Calculate statistics
        const activeAgreements = companyAgreements.filter(a => a.status === 'active').length;
        const totalSites = new Set(
          companyAgreements.flatMap(a => a.siteIds || [])
        ).size;
        
        const totalPanels = companyAgreements.reduce((sum, agreement) => {
          return sum + Object.values(agreement.sitePanelCounts || {}).reduce((siteSum, count) => siteSum + parseInt(count || 0), 0);
        }, 0);
        
        const totalRevenue = companyAgreements.reduce((sum, agreement) => sum + (agreement.totalAmount || 0), 0);
        
        setStats({
          totalAgreements: companyAgreements.length,
          activeAgreements,
          totalSites,
          totalPanels,
          totalRevenue
        });
      } catch (error) {
        console.error('Error fetching company data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [companyId, navigate]);

  // Initialize helper functions
  const helpers = AgreementHelpers({
    companies: company ? [company] : [],
    sites,
    agreements
  });

  // Get site name by ID
  const getSiteName = (siteId) => {
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : 'Bilinmeyen Site';
  };

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount);
  };

  // Format date
  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('tr-TR');
  };

  // Get panel count for a specific site in an agreement
  const getPanelCountForSite = (agreement, siteId) => {
    return agreement.sitePanelCounts?.[siteId] || 0;
  };

  // Get active sites for an agreement
  const getActiveSites = (agreement) => {
    return (agreement.siteIds || []).map(siteId => ({
      id: siteId,
      name: getSiteName(siteId),
      panels: getPanelCountForSite(agreement, siteId)
    }));
  };

  // Get site details by ID
  const getSiteById = (siteId) => {
    return sites.find(s => String(s.id) === String(siteId)) || null;
  };

  // Get payment transactions for the current company
  const getCompanyPayments = () => {
    if (!company || !transactions.length) return [];
    return transactions.filter(transaction => 
      transaction.type === 'income' && 
      transaction.source.includes('Anlaşma Ödemesi') &&
      transaction.source.includes(company.name)
    );
  };

  // Get company agreements and payments for display
  const companyAgreements = agreements;
  const companyPayments = getCompanyPayments();

  // Filter agreements by date
  const filterAgreementsByDate = (date) => {
    if (!date) {
      setFilteredAgreements(companyAgreements);
      return;
    }
    
    const filtered = companyAgreements.filter(agreement => {
      const agreementDate = new Date(agreement.startDate);
      const selectedDateObj = new Date(date);
      return agreementDate.toDateString() === selectedDateObj.toDateString();
    });
    setFilteredAgreements(filtered);
  };

  // Handle date filter change
  const handleDateFilterChange = (date) => {
    setSelectedDate(date);
    filterAgreementsByDate(date);
  };

  // Get panel information for a specific panel
  const getPanelInfo = (siteId, blockId, panelId) => {
    const relevantAgreements = agreements.filter(agreement =>
      agreement.siteIds && agreement.siteIds.includes(siteId)
    );

    for (const agreement of relevantAgreements) {
      if (agreement.sitePanelSelections && agreement.sitePanelSelections[siteId]) {
        if (agreement.sitePanelSelections[siteId][blockId]) {
          if (agreement.sitePanelSelections[siteId][blockId].includes(panelId)) {
            return {
              isUsed: true,
              companyName: getCompanyName(agreement.companyId),
              startDate: agreement.startDate,
              endDate: agreement.endDate,
              agreementId: agreement.id,
              status: agreement.status,
              isActive: agreement.status === 'active'
            };
          }
        }
      }
    }
    return { isUsed: false };
  };

  // Check if panel should be highlighted for selected date
  const isPanelHighlightedForDate = (siteId, blockId, panelId) => {
    if (!selectedDate) return false;
    
    const panelInfo = getPanelInfo(siteId, blockId, panelId);
    if (!panelInfo.isUsed) return false;
    
    const agreementDate = new Date(panelInfo.startDate);
    const selectedDateObj = new Date(selectedDate);
    return agreementDate.toDateString() === selectedDateObj.toDateString();
  };







  if (loading) {
    return (
      <div className="d-flex justify-content-center align-items-center min-vh-100">
        <div className="text-center">
          <div className="loading-spinner mx-auto"></div>
          <p className="mt-3 text-muted">Firma bilgileri yükleniyor...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    navigate('/');
    return null;
  }

  return (
    <div className="container-fluid">
      {/* Header */}
      <div className="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 className="h3 fw-bold">{company?.name || user.name} - Firma Panosu</h2>
          <p className="text-muted mb-0">Firma ID: {companyId}</p>
        </div>
        <div className="text-end">
          <button 
            className="btn btn-outline-danger"
            onClick={() => {
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              navigate('/');
            }}
          >
            <i className="bi bi-box-arrow-right me-1"></i>
            Çıkış Yap
          </button>
        </div>
      </div>

      {/* Credit Information Section */}
      {company && (
        <div className="row g-4 mb-4">
          <div className="col-md-12">
            <div className="card custom-card shadow-sm">
              <div className="card-header bg-info-subtle">
                <h5 className="mb-0 fw-bold">
                  <i className="bi bi-credit-card me-2"></i>
                  Kredi Bilgileri
                </h5>
              </div>
              <div className="card-body">
                <div className="row g-3">
                  <div className="col-lg-3 col-md-6">
                    <div className="card h-100 border-info">
                      <div className="card-body text-center">
                        <i className="bi bi-wallet fs-1 text-info mb-2"></i>
                        <h6 className="card-title">Mevcut Kredi</h6>
                        <h3 className="card-text text-info">{company.credit || 0} Panel</h3>
                      </div>
                    </div>
                  </div>
                  
                  <div className="col-lg-3 col-md-6">
                    <div className="card h-100 border-success">
                      <div className="card-body text-center">
                        <i className="bi bi-currency-dollar fs-1 text-success mb-2"></i>
                        <h6 className="card-title">Toplam Kredi Satın Alımı</h6>
                        <h3 className="card-text text-success">
                          {company.creditHistory ? company.creditHistory.length : 0}
                        </h3>
                      </div>
                    </div>
                  </div>
                  
                  <div className="col-lg-3 col-md-6">
                    <div className="card h-100 border-warning">
                      <div className="card-body text-center">
                        <i className="bi bi-tag fs-1 text-warning mb-2"></i>
                        <h6 className="card-title">Toplam Kredi Paneli</h6>
                        <h3 className="card-text text-warning">
                          {company.creditHistory ? company.creditHistory.reduce((sum, credit) => sum + (credit.panelCount || 0), 0) : 0} Panel
                        </h3>
                      </div>
                    </div>
                  </div>
                  
                  <div className="col-lg-3 col-md-6">
                    <div className="card h-100 border-primary">
                      <div className="card-body text-center">
                        <i className="bi bi-cash fs-1 text-primary mb-2"></i>
                        <h6 className="card-title">Toplam Kredi Tutarı</h6>
                        <h4 className="card-text text-primary">
                          {formatCurrency(company.creditHistory ? company.creditHistory.reduce((sum, credit) => sum + (credit.totalAmount || 0), 0) : 0)}
                        </h4>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Credit History Table */}
                {company.creditHistory && company.creditHistory.length > 0 && (
                  <div className="mt-4">
                    <h6 className="fw-bold mb-3">
                      <i className="bi bi-clock-history me-2"></i>
                      Kredi Geçmişi
                    </h6>
                    <div className="table-responsive">
                      <table className="table custom-table">
                        <thead>
                          <tr>
                            <th>Tarih</th>
                            <th>Panel Sayısı</th>
                            <th>Panel Ücreti</th>
                            <th>Toplam Tutar</th>
                          </tr>
                        </thead>
                        <tbody>
                          {[...company.creditHistory].reverse().map((credit, index) => (
                            <tr key={index}>
                              <td>{formatDate(credit.purchaseDate)}</td>
                              <td>{credit.panelCount} Panel</td>
                              <td>{formatCurrency(credit.panelPrice)}</td>
                              <td className="fw-bold">{formatCurrency(credit.totalAmount)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Statistics Cards */}
      <div className="row g-3 mb-4">
        <div className="col-lg-2 col-md-4">
          <div className="card custom-card bg-primary text-white">
            <div className="card-body text-center">
              <i className="bi bi-file-earmark-text fs-1 mb-2"></i>
              <h6 className="card-title">Toplam Anlaşma</h6>
              <h3 className="card-text">{stats.totalAgreements}</h3>
            </div>
          </div>
        </div>
        <div className="col-lg-2 col-md-4">
          <div className="card custom-card bg-success text-white">
            <div className="card-body text-center">
              <i className="bi bi-check-circle fs-1 mb-2"></i>
              <h6 className="card-title">Aktif Anlaşma</h6>
              <h3 className="card-text">{stats.activeAgreements}</h3>
            </div>
          </div>
        </div>
        <div className="col-lg-2 col-md-4">
          <div className="card custom-card bg-info text-white">
            <div className="card-body text-center">
              <i className="bi bi-building fs-1 mb-2"></i>
              <h6 className="card-title">Toplam Site</h6>
              <h3 className="card-text">{stats.totalSites}</h3>
            </div>
          </div>
        </div>
        <div className="col-lg-3 col-md-6">
          <div className="card custom-card bg-warning text-white">
            <div className="card-body text-center">
              <i className="bi bi-tv fs-1 mb-2"></i>
              <h6 className="card-title">Toplam Panel</h6>
              <h3 className="card-text">{stats.totalPanels}</h3>
            </div>
          </div>
        </div>
        <div className="col-lg-3 col-md-6">
          <div className="card custom-card bg-success text-white">
            <div className="card-body text-center">
              <i className="bi bi-currency-dollar fs-1 mb-2"></i>
              <h6 className="card-title">Toplam Tutar</h6>
              <h4 className="card-text">{formatCurrency(stats.totalRevenue)}</h4>
            </div>
          </div>
        </div>
      </div>

      {/* Agreements Section - Enhanced with payment information */}
      <div className="row g-4 mb-4">
        <div className="col-md-12">
          <div className="card custom-card shadow-sm">
            <div className="card-header bg-primary-subtle">
              <h5 className="mb-0 fw-bold">
                <i className="bi bi-file-earmark-text me-2"></i>
                Anlaşma Geçmişi
              </h5>
            </div>
            <div className="card-body">
              {companyAgreements.length === 0 ? (
                <div className="text-center py-4">
                  <i className="bi bi-file-earmark text-muted fs-1"></i>
                  <p className="text-muted mt-2">Henüz anlaşma bulunmamaktadır.</p>
                </div>
              ) : (
                <div className="table-responsive">
                  <table className="table custom-table">
                    <thead>
                      <tr>
                        <th>Başlangıç Tarihi</th>
                        <th>Bitiş Tarihi</th>
                        <th>Süre (Hafta)</th>
                        <th>Toplam Pano</th>
                        <th>Birim Fiyat (₺)</th>
                        <th>Toplam Tutar</th>
                        <th>Ödenen Tutar</th>
                        <th>Durum</th>
                      </tr>
                    </thead>
                    <tbody>
                      {companyAgreements.map((agreement) => {
                        // Calculate total panels for this agreement
                        const totalPanels = Object.values(agreement.sitePanelCounts || {}).reduce(
                          (sum, count) => sum + parseInt(count || 0), 0
                        );
                        
                        // Find payment for this agreement
                        const payment = companyPayments.find(p => 
                          p.description && p.description.includes(agreement.id)
                        );
                        
                        return (
                          <tr key={agreement.id}>
                            <td>{formatDate(agreement.startDate)}</td>
                            <td>{formatDate(agreement.endDate)}</td>
                            <td>{agreement.totalWeeks}</td>
                            <td>{totalPanels}</td>
                            <td>{formatCurrency(agreement.weeklyRatePerPanel)}</td>
                            <td className="fw-bold">{formatCurrency(agreement.totalAmount)}</td>
                            <td>
                              {payment ? (
                                <span className="text-success fw-bold">{formatCurrency(payment.amount)}</span>
                              ) : (
                                <span className="text-muted">Ödeme yapılmadı</span>
                              )}
                            </td>
                            <td>
                              <span className={`badge ${
                                agreement.status === 'active' 
                                  ? 'bg-success-subtle text-success-emphasis' 
                                  : 'bg-danger-subtle text-danger-emphasis'
                              }`}>
                                {agreement.status === 'active' ? 'Aktif' : 'Pasif'}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Active Agreement Images Management */}
      {companyAgreements.length > 0 && (
        <div className="row g-4 mb-4">
          <div className="col-md-12">
            <div className="card custom-card shadow-sm">
              <div className="card-header bg-warning-subtle">
                <h5 className="mb-0 fw-bold">
                  <i className="bi bi-camera me-2"></i>
                  Aktif Anlaşma Görselleri
                </h5>
              </div>
              <div className="card-body">
                <div className="row g-4">
                  {companyAgreements.filter(a => a.status === 'active').map((agreement) => (
                    <div key={agreement.id} className="col-lg-12">
                      <div className="card border-warning h-100">
                        <div className="card-header bg-warning-subtle">
                          <div className="d-flex justify-content-between align-items-center">
                            <div>
                              <h6 className="mb-0 fw-bold">
                                <i className="bi bi-file-earmark-text me-2"></i>
                                Anlaşma ID: {agreement.id}
                              </h6>
                              <small className="text-muted">
                                {formatDate(agreement.startDate)} - {formatDate(agreement.endDate)}
                              </small>
                            </div>
                            <div className="fw-bold text-warning">
                              {formatCurrency(agreement.totalAmount)}
                            </div>
                          </div>
                        </div>
                        <div className="card-body">
                          {/* Panel Images Management */}
                          <div className="row g-3">
                            {(agreement.siteIds || []).map((siteId) => {
                              const site = getSiteById(siteId);
                              if (!site) return null;
                              
                              const blockCount = parseInt(site.blocks) || 0;
                              const elevatorsPerBlock = parseInt(site.elevatorsPerBlock) || 0;
                              const panelsPerBlock = elevatorsPerBlock * 2;
                              const blockLabels = helpers.generateBlockLabels(blockCount);
                              const usedBlocks = agreement.siteBlockSelections?.[siteId] || [];
                              const panelSelections = agreement.sitePanelSelections?.[siteId] || {};
                              
                              return (
                                <div key={siteId} className="col-md-12">
                                  <div className="card border-info">
                                    <div className="card-header bg-info-subtle">
                                      <h6 className="mb-0">
                                        <i className="bi bi-building me-2"></i>
                                        {site.name}
                                      </h6>
                                    </div>
                                    <div className="card-body">
                                      {usedBlocks.length === 0 ? (
                                        <div className="text-center py-3 text-muted">
                                          <i className="bi bi-exclamation-triangle"></i>
                                          <p className="mb-0 mt-2">Bu anlaşma için blok bilgisi bulunamadı.</p>
                                        </div>
                                      ) : (
                                        <div className="d-flex flex-wrap gap-2">
                                          {usedBlocks.map((blockId) => {
                                            const blockIndex = parseInt(blockId.split('-')[1]);
                                            const blockLabel = blockLabels[blockIndex];
                                            const usedPanels = panelSelections[blockId] || [];
                                            
                                            return (
                                              <div key={blockId} className="d-flex flex-wrap gap-1">
                                                {Array.from({ length: panelsPerBlock }, (_, panelIndex) => {
                                                  const panelId = `panel-${panelIndex}`;
                                                  const isPanelUsed = usedPanels.includes(panelId);
                                                  const panelNumber = panelIndex + 1;
                                                  const fullPanelNumber = `${blockLabel}${panelNumber}`;
                                                  
                                                  return (
                                                    <div
                                                      key={panelId}
                                                      className={`d-flex align-items-center justify-content-center ${
                                                        isPanelUsed ? 'bg-primary text-white' : 'bg-light text-muted'
                                                      } border rounded position-relative overflow-hidden`}
                                                      style={{
                                                        width: '120px',
                                                        height: '140px',
                                                        fontSize: '10px',
                                                        fontWeight: 'bold',
                                                        flexDirection: 'column',
                                                        cursor: isPanelUsed ? 'pointer' : 'default'
                                                      }}
                                                      title={isPanelUsed ? `Panel ${fullPanelNumber} - Görsel yüklemek için tıklayın` : `Panel ${fullPanelNumber} - Boş`}
                                                      onClick={() => {
                                                        if (isPanelUsed) {
                                                          // Show image upload modal
                                                          showImageUploadModal(agreement.id, siteId, blockId, panelId, fullPanelNumber);
                                                        }
                                                      }}
                                                    >
                                                      {isPanelUsed && agreement.photoUrl ? (
                                                        <>
                                                          <div 
                                                            className="position-absolute w-100 h-100 d-flex align-items-center justify-content-center"
                                                            style={{
                                                              backgroundImage: `url(${agreement.photoUrl})`,
                                                              backgroundSize: 'cover',
                                                              backgroundPosition: 'center',
                                                              backgroundRepeat: 'no-repeat',
                                                              opacity: 0.8
                                                            }}
                                                          >
                                                            <div className="bg-dark bg-opacity-75 text-white p-1 rounded" style={{ fontSize: '8px' }}>
                                                              #{fullPanelNumber}
                                                            </div>
                                                          </div>
                                                          <div className="position-absolute" style={{ top: '2px', right: '2px' }}>
                                                            <i className="bi bi-image text-warning" style={{ fontSize: '12px' }}></i>
                                                          </div>
                                                        </>
                                                      ) : (
                                                        <>
                                                          <div className="fw-bold">#{fullPanelNumber}</div>
                                                          {isPanelUsed && (
                                                            <>
                                                              <div className="text-truncate" style={{ fontSize: '8px', maxWidth: '100px' }}>
                                                                {company?.name || 'Firma'}
                                                              </div>
                                                              <div className="position-absolute" style={{ top: '2px', right: '2px' }}>
                                                                <i className="bi bi-camera text-muted" style={{ fontSize: '12px' }}></i>
                                                              </div>
                                                            </>
                                                          )}
                                                        </>
                                                      )}
                                                    </div>
                                                  );
                                                })}
                                              </div>
                                            );
                                          })}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Active Agreements Visualization */}
      {companyAgreements.filter(a => a.status === 'active').length > 0 && (
        <div className="row g-4">
          <div className="col-md-12">
            <div className="card custom-card shadow-sm">
              <div className="card-header bg-success-subtle">
                <h5 className="mb-0 fw-bold">
                  <i className="bi bi-tv me-2"></i>
                  Aktif Anlaşmalar - Site/Blok/Panel Görselleştirmesi
                </h5>
              </div>
              <div className="card-body">
                <div className="row g-4">
                  {companyAgreements.filter(a => a.status === 'active').map((agreement) => (
                    <div key={agreement.id} className="col-lg-12">
                      <div className="card border-success h-100">
                        <div className="card-header bg-success-subtle">
                          <div className="d-flex justify-content-between align-items-center">
                            <div>
                              <h6 className="mb-0 fw-bold">
                                <i className="bi bi-file-earmark-text me-2"></i>
                                Anlaşma ID: {agreement.id}
                              </h6>
                              <small className="text-muted">
                                {formatDate(agreement.startDate)} - {formatDate(agreement.endDate)}
                              </small>
                            </div>
                            <div className="fw-bold text-success">
                              {formatCurrency(agreement.totalAmount)}
                            </div>
                          </div>
                        </div>
                        <div className="card-body">
                          {/* Sites, Blocks, and Panels Visualization */}
                          <div className="row g-3">
                            {(agreement.siteIds || []).map((siteId) => {
                              const site = getSiteById(siteId);
                              if (!site) return null;
                              
                              const blockCount = parseInt(site.blocks) || 0;
                              const elevatorsPerBlock = parseInt(site.elevatorsPerBlock) || 0;
                              const panelsPerBlock = elevatorsPerBlock * 2;
                              const blockLabels = helpers.generateBlockLabels(blockCount);
                              const usedBlocks = agreement.siteBlockSelections?.[siteId] || [];
                              const panelSelections = agreement.sitePanelSelections?.[siteId] || {};
                              
                              return (
                                <div key={siteId} className="col-md-12">
                                  <div className="card border-primary">
                                    <div className="card-header bg-primary-subtle">
                                      <div className="d-flex justify-content-between align-items-center">
                                        <h6 className="mb-0">
                                          <i className="bi bi-building me-2"></i>
                                          {site.name}
                                        </h6>
                                        <span className="badge bg-info-subtle text-info-emphasis">
                                          {Object.values(agreement.sitePanelCounts || {}).reduce((sum, count) => sum + parseInt(count || 0), 0)} panel
                                        </span>
                                      </div>
                                    </div>
                                    <div className="card-body">
                                      {usedBlocks.length === 0 ? (
                                        <div className="text-center py-3 text-muted">
                                          <i className="bi bi-exclamation-triangle"></i>
                                          <p className="mb-0 mt-2">Bu anlaşma için blok bilgisi bulunamadı.</p>
                                        </div>
                                      ) : (
                                        <div className="row g-3">
                                          {usedBlocks.map((blockId) => {
                                            const blockIndex = parseInt(blockId.split('-')[1]);
                                            const blockLabel = blockLabels[blockIndex];
                                            const usedPanels = panelSelections[blockId] || [];
                                            
                                            return (
                                              <div key={blockId} className="col-md-6 col-lg-4">
                                                <div className="card border-info">
                                                  <div className="card-header bg-info-subtle">
                                                    <h6 className="mb-0 fw-bold">
                                                      <i className="bi bi-grid-3x3-gap me-1"></i>
                                                      {blockLabel} Blok
                                                    </h6>
                                                  </div>
                                                  <div className="card-body">
                                                    <div className="small text-muted mb-2">
                                                      Kullanılan Paneller: {usedPanels.length} / {panelsPerBlock}
                                                    </div>
                                                    <div className="d-flex flex-wrap gap-1">
                                                      {Array.from({ length: panelsPerBlock }, (_, panelIndex) => {
                                                        const panelId = `panel-${panelIndex}`;
                                                        const isPanelUsed = usedPanels.includes(panelId);
                                                        const panelNumber = panelIndex + 1;
                                                        
                                                        // Get panel usage information if panel is used
                                                        let panelUsageInfo = null;
                                                        if (isPanelUsed) {
                                                          panelUsageInfo = helpers.getPanelUsageInfo(
                                                            siteId,
                                                            blockId,
                                                            panelId,
                                                            agreement.startDate,
                                                            agreement.endDate
                                                          );
                                                        }
                                                        
                                                        return (
                                                          <div
                                                            key={panelId}
                                                            className={`d-flex align-items-center justify-content-center ${
                                                              isPanelUsed ? 'bg-primary text-white' : 'bg-light text-muted'
                                                            } border rounded position-relative`}
                                                            style={{
                                                              width: '40px',
                                                              height: '40px',
                                                              fontSize: '8px',
                                                              fontWeight: 'bold',
                                                              flexDirection: 'column',
                                                              cursor: 'default'
                                                            }}
                                                            title={isPanelUsed ? `Panel ${panelNumber} - ${company?.name || 'Firma'}` : `Panel ${panelNumber} - Boş`}
                                                          >
                                                            <div>{panelNumber}</div>
                                                            {isPanelUsed && (
                                                              <div className="text-truncate" style={{ fontSize: '7px', lineHeight: '1', maxWidth: '35px' }}>
                                                                {(company?.name || 'Firma').length > 5 ? (company?.name || 'Firma').substring(0, 5) + '...' : (company?.name || 'Firma')}
                                                              </div>
                                                            )}
                                                            {isPanelUsed && (
                                                              <div className="position-absolute top-0 end-0" style={{ fontSize: '6px' }}>
                                                                  <i className="bi bi-lock-fill"></i>
                                                                </div>
                                                              )}
                                                            </div>
                                                        );
                                                      })}
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          
                          {/* Agreement Photo */}
                          {agreement.photoUrl && (
                            <div className="mt-4">
                              <h6 className="fw-bold mb-3">
                                <i className="bi bi-image me-2"></i>
                                Reklam Görseli
                              </h6>
                              <div className="text-center">
                                <img 
                                  src={agreement.photoUrl} 
                                  alt="Reklam Görseli" 
                                  className="img-fluid rounded border"
                                  style={{ maxHeight: '300px', objectFit: 'contain' }}
                                />
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default CompanyDashboard;