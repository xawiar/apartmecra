import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const handleAddAgreement = () => {
    setFormData({
      companyId: '',
      startDate: '',
      endDate: '',
      weeklyRatePerPanel: '',
      notes: ''
    });
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(null);
    setShowAddForm(true);
  };

  const handleEditAgreement = (agreement) => {
    setFormData({
      companyId: agreement.companyId || '',
      startDate: agreement.startDate || '',
      endDate: agreement.endDate || '',
      weeklyRatePerPanel: agreement.weeklyRatePerPanel || '',
      notes: agreement.notes || ''
    });
    // For editing, we would need to populate selectedSites and sitePanelCounts
    // This would require additional data structure in the agreement object
    setSelectedSites([]);
    setSitePanelCounts({});
    setSiteBlockSelections({});
    setSitePanelSelections({});
    setCurrentAgreement(agreement);
    setShowAddForm(true);
  };

  const handleCloseAddForm = () => {
    setShowAddForm(false);
    setCurrentAgreement(null);
    setSelectedSites([]);
    setSitePanelCounts({});
    setSelectedWeeks([]);
    setSiteBlockSelections({});
    setSitePanelSelections({});
  };

  const handleArchiveAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Arşivleme',
      'Bu anlaşmayı arşivlemek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await archiveAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma arşivlendi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma arşivlenirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error archiving agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // New function to delete all agreements and archive them
  const handleDeleteAllAgreements = async () => {
    if (agreements.length === 0) {
      await window.showAlert(
        'Bilgi',
        'Silinecek anlaşma bulunmamaktadır.',
        'info'
      );
      return;
    }

    const result = await window.showConfirm(
      'Tüm Anlaşmaları Sil',
      `Tüm ${agreements.length} anlaşmayı arşivlemek istediğinize emin misiniz?`,
      'warning'
    );
    
    if (result) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Archive each agreement
        for (const agreement of agreements) {
          try {
            const success = await archiveAgreement(agreement.id);
            if (success) {
              successCount++;
              // Log the action
              await createLog({
                user: 'Admin',
                action: `Anlaşma arşivlendi: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
              });
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error('Error archiving agreement:', error);
            errorCount++;
          }
        }
        
        // Update state to remove all agreements
        setAgreements([]);
        
        await window.showAlert(
          'İşlem Tamamlandı',
          `${successCount} anlaşma başarıyla arşivlendi. ${errorCount} anlaşma arşivlenirken hata oluştu.`,
          'info'
        );
      } catch (error) {
        console.error('Error deleting all agreements:', error);
        await window.showAlert(
          'Hata',
          'Anlaşmalar arşivlenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleSaveAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const newAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await createAgreement(newAgreement);
      if (savedAgreement) {
        setAgreements([...agreements, savedAgreement]);
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla oluşturuldu.', 'success');
      }
    } catch (error) {
      console.error('Error creating agreement:', error);
      showAlertModal('Hata', 'Anlaşma oluşturulurken bir hata oluştu.', 'error');
    }
  };

  const handleUpdateAgreement = async () => {
    const { companyId, startDate, endDate, weeklyRatePerPanel, notes } = formData;
    const siteIds = selectedSites;
    const sitePanelCounts = Object.fromEntries(
      Object.entries(sitePanelSelections).map(([siteId, blockPanels]) => {
        return [siteId, Object.values(blockPanels).reduce((sum, panels) => sum + panels.length, 0)];
      })
    );
    const totalPanels = Object.values(sitePanelCounts).reduce((sum, panels) => sum + panels, 0);
    const totalWeeks = selectedWeeks.length;
    const totalAmount = totalPanels * totalWeeks * weeklyRatePerPanel;

    if (!companyId || !startDate || !endDate || !weeklyRatePerPanel || !totalPanels || !totalWeeks) {
      showAlertModal('Hata', 'Lütfen tüm alanları doldurun.', 'error');
      return;
    }

    try {
      const updatedAgreement = {
        companyId,
        startDate,
        endDate,
        weeklyRatePerPanel,
        siteIds,
        sitePanelCounts,
        totalPanels,
        totalWeeks,
        totalAmount,
        status: 'active',
        isPaid: false,
        notes
      };

      const savedAgreement = await updateAgreement(currentAgreement.id, updatedAgreement);
      if (savedAgreement) {
        setAgreements(agreements.map(a => (a.id === currentAgreement.id ? savedAgreement : a)));
        handleCloseAddForm();
        showAlertModal('Başarılı', 'Anlaşma başarıyla güncellendi.', 'success');
      }
    } catch (error) {
      console.error('Error updating agreement:', error);
      showAlertModal('Hata', 'Anlaşma güncellenirken bir hata oluştu.', 'error');
    }
  };

  const handleDeleteAgreement = async (agreementId) => {
    const result = await window.showConfirm(
      'Anlaşma Silme',
      'Bu anlaşmayı silmek istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        const success = await deleteAgreement(agreementId);
        if (success) {
          setAgreements(agreements.filter(agreement => agreement.id !== agreementId));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma silindi: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
        } else {
          await window.showAlert(
            'Hata',
            'Anlaşma silinirken bir hata oluştu.',
            'error'
          );
        }
      } catch (error) {
        console.error('Error deleting agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma silinirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  // Function to renew an agreement
  const handleRenewAgreement = async (agreement) => {
    // Check if agreement is still active
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const agreementEndDate = new Date(agreement.endDate);
    agreementEndDate.setHours(0, 0, 0, 0);
    
    // If agreement is still active, renewal is not allowed
    if (agreement.status === 'active' && agreementEndDate >= today) {
      await window.showAlert(
        'Yenileme Yapılamıyor',
        'Anlaşma süresi devam ettiği için yenileme yapılamaz. Aynı tarihlerde aynı firma ile yeni anlaşma yapılamaz.',
        'warning'
      );
      return;
    }
    
    // Confirm renewal
    const result = await window.showConfirm(
      'Anlaşma Yenileme',
      'Bu anlaşmayı aynı şartlarla yenilemek istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        // Calculate new dates (extend by the same duration as original agreement)
        const originalStart = new Date(agreement.startDate);
        const originalEnd = new Date(agreement.endDate);
        const duration = originalEnd - originalStart;
        
        // New agreement starts the day after the original ends
        const newStartDate = new Date(originalEnd);
        newStartDate.setDate(newStartDate.getDate() + 1);
        
        // New agreement ends after the same duration
        const newEndDate = new Date(newStartDate);
        newEndDate.setTime(newEndDate.getTime() + duration);
        
        // Prepare new agreement data with same terms
        const newAgreementData = {
          companyId: agreement.companyId,
          startDate: newStartDate.toISOString().split('T')[0],
          endDate: newEndDate.toISOString().split('T')[0],
          weeklyRatePerPanel: agreement.weeklyRatePerPanel,
          siteIds: agreement.siteIds,
          sitePanelCounts: agreement.sitePanelCounts,
          totalPanels: agreement.totalPanels,
          totalWeeks: agreement.totalWeeks,
          totalAmount: agreement.totalAmount,
          status: 'active',
          isPaid: false,
          notes: agreement.notes ? `${agreement.notes} (Yenilenen anlaşma)` : 'Yenilenen anlaşma'
        };
        
        // Create new agreement
        const newAgreement = await createAgreement(newAgreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma yenilendi: ${getCompanyName(agreement.companyId)}`
          });
          
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };
</original_code>```

```
import React, { useState, useEffect } from 'react';
import { getAgreements, createAgreement, updateAgreement, deleteAgreement, archiveAgreement } from '../services/api';
import { getSites, updateSite } from '../services/api';
import { getCompanies, updateCompany } from '../services/api';
import { createTransaction } from '../services/api';
import { createLog } from '../services/api';

const Agreements = () => {
  const [agreements, setAgreements] = useState([]);
  const [sites, setSites] = useState([]);
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [currentAgreement, setCurrentAgreement] = useState(null);
  const [selectedSites, setSelectedSites] = useState([]);
  const [sitePanelCounts, setSitePanelCounts] = useState({});
  const [selectedWeeks, setSelectedWeeks] = useState([]);
  // New state for block and panel selection
  const [siteBlockSelections, setSiteBlockSelections] = useState({}); // {siteId: [selectedBlockIds]}
  const [sitePanelSelections, setSitePanelSelections] = useState({}); // {siteId: {blockId: [selectedPanelIds]}}
  
  const [formData, setFormData] = useState({
    companyId: '',
    startDate: '',
    endDate: '',
    weeklyRatePerPanel: '',
    notes: ''
  });
  
  // State for custom alert modals
  const [alertModal, setAlertModal] = useState({
    show: false,
    title: '',
    message: '',
    type: 'info' // info, success, warning, error
  });

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [agreementsData, sitesData, companiesData] = await Promise.all([
          getAgreements(),
          getSites(),
          getCompanies()
        ]);
        
        // Initialize sites with payment properties
        const initializedSites = sitesData.map(site => ({
          ...site,
          pendingPayments: site.pendingPayments || [],
          hasPendingPayment: (site.pendingPayments && site.pendingPayments.length > 0) || false
        }));
        
        setAgreements(agreementsData);
        setSites(initializedSites);
        setCompanies(companiesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    
    // Check for expired agreements every minute
    const interval = setInterval(checkExpiredAgreements, 60000);
    
    return () => clearInterval(interval);
  }, []);

  // Update panel counts whenever panel selections change
  useEffect(() => {
    selectedSites.forEach(siteId => {
      updateSitePanelCount(siteId);
    });
  }, [sitePanelSelections, selectedSites]);

  // Function to show custom alert modals
  const showAlertModal = (title, message, type = 'info') => {
    setAlertModal({
      show: true,
      title,
      message,
      type
    });
  };

  // Function to close alert modal
  const closeAlertModal = () => {
    setAlertModal({
      show: false,
      title: '',
      message: '',
      type: 'info'
    });
  };

  // Check for expired agreements and mark them as inactive
  const checkExpiredAgreements = async () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    
    for (const agreement of agreements) {
      // If agreement is active and end date has passed, mark as inactive
      const agreementEndDate = new Date(agreement.endDate);
      agreementEndDate.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      if (agreement.status === 'active' && agreementEndDate < today) {
        try {
          const updatedAgreement = { ...agreement, status: 'inactive' };
          const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
          
          if (savedAgreement) {
            // Update in state
            setAgreements(agreements.map(a => 
              a.id === agreement.id ? savedAgreement : a
            ));
            
            // Log the action
            await createLog({
              user: 'System',
              action: `Anlaşma otomatik olarak pasif yapıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
            });
          }
        } catch (error) {
          console.error('Error updating agreement status:', error);
        }
      }
    }
  };

  const handleShowAgreement = (agreement) => {
    setCurrentAgreement(agreement);
    setShowModal(true);
  };

  const handleCloseModal = () => {
    setShowModal(false);
    setCurrentAgreement(null);
  };

  const getBlockName = (siteId, blockId) => {
    const site = sites.find(site => site.id === siteId);
    const block = site?.blocks?.find(block => block.id === blockId);
    return block ? block.name : 'Bilinmeyen Blok';
  };

  const getPanelName = (siteId, blockId, panelId) => {
    const site = sites.find(site => site.id === siteId);
    const block = site?.blocks?.find(block => block.id === blockId);
    const panel = block?.panels?.find(panel => panel.id === panelId);
    return panel ? panel.name : 'Bilinmeyen Panel';
  };

  const handlePayment = async (agreementId) => {
    const result = await window.showConfirm(
      'Ödeme İşlemi',
      'Bu anlaşmayı ödeme yapmak istediğinize emin misiniz?',
      'info'
    );
    
    if (result) {
      try {
        const success = await createTransaction(agreementId);
        if (success) {
          setAgreements(agreements.map(a => (a.id === agreementId ? { ...a, isPaid: true } : a)));
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma ödeme yapıldı: ${getCompanyName((agreements.find(a => a.id === agreementId) || {}).companyId || '')} (ID: ${agreementId})`
          });
          // Show success message
          await window.showAlert(
            'Başarılı',
            'Anlaşma başarıyla yenilendi.',
            'success'
          );
        } else {
          throw new Error('Anlaşma yenilenemedi');
        }
      } catch (error) {
        console.error('Error renewing agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma yenilenirken bir hata oluştu: ' + error.message,
          'error'
        );
      }
    }
  };

  const handlePaymentAgreement = async (agreement) => {
    // Check if payment has already been made
    if (agreement.isPaid) {
      await window.showAlert(
        'Ödeme Yapılamıyor',
        'Bu anlaşma için zaten ödeme alınmıştır.',
        'warning'
      );
      return;
    }

    // Create income transaction for the agreement payment
    const incomeData = {
      date: new Date().toISOString().split('T')[0],
      type: 'income',
      source: `Anlaşma Ödemesi - ${getCompanyName(agreement.companyId)}`,
      description: `${getCompanyName(agreement.companyId)} anlaşması için ödeme (${agreement.totalWeeks} hafta)`,
      amount: agreement.totalAmount
    };
    
    try {
      // Add payment to cashier
      const newTransaction = await createTransaction(incomeData);
      
      if (newTransaction) {
        // Update the agreement to mark it as paid
        const updatedAgreement = { ...agreement, isPaid: true };
        const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
        
        if (savedAgreement) {
          // Update agreements in state
          setAgreements(agreements.map(a => a.id === agreement.id ? savedAgreement : a));
        }
        
        // Get company name for site payment details
        const companyName = getCompanyName(agreement.companyId);
        
        // Update sites with their individual payment amounts using the formula:
        // panel count * weekly rate per panel * weeks * site agreement percentage / 100
        const updatedSites = sites.map(site => {
          if (agreement.siteIds.includes(site.id)) {
            // Calculate site's share using the formula:
            // panel count * weekly rate per panel * weeks * site agreement percentage / 100
            const panelCount = parseInt(agreement.sitePanelCounts[site.id]) || 0;
            const weeklyRate = parseFloat(agreement.weeklyRatePerPanel) || 0;
            const weeks = parseInt(agreement.totalWeeks) || 0;
            const percentage = parseFloat(site.agreementPercentage) || 0;
            
            // Apply the formula: panel count * weekly rate * weeks * percentage / 100
            const siteShare = (panelCount * weeklyRate * weeks * percentage) / 100;
            
            // Add this payment to the site's pending payments array
            const newPendingPayment = {
              agreementId: agreement.id,
              companyName: companyName,
              amount: siteShare,
              date: new Date().toISOString().split('T')[0]
            };
            
            const updatedPendingPayments = [...(site.pendingPayments || []), newPendingPayment];
            
            // Update site with the new pending payment
            return {
              ...site,
              pendingPayments: updatedPendingPayments,
              hasPendingPayment: updatedPendingPayments.length > 0
            };
          }
          return site;
        });
        
        setSites(updatedSites);
        
        // Update sites in the backend
        for (const updatedSite of updatedSites) {
          if (agreement.siteIds.includes(updatedSite.id)) {
            try {
              await updateSite(updatedSite.id, updatedSite);
            } catch (error) {
              console.error('Error updating site:', error);
            }
          }
        }
        
        // Log the action
        await createLog({
          user: 'Admin',
          action: `Anlaşma ödemesi alındı: ${getCompanyName(agreement.companyId)} (${formatCurrency(agreement.totalAmount)})`
        });
        
        // Show success message
        await window.showAlert(
          'Ödeme Başarılı',
          `${formatCurrency(agreement.totalAmount)} tutarında anlaşma ödemesi alındı ve sitelere dağıtıldı.`,
          'success'
        );
      }
    } catch (error) {
      console.error('Error processing agreement payment:', error);
      await window.showAlert(
        'Hata',
        'Ödeme işlemi sırasında bir hata oluştu.',
        'error'
      );
    }
  };

  // Add the terminate agreement early function
  const handleTerminateAgreement = async (agreement) => {
    const result = await window.showConfirm(
      'Anlaşma Erken Sonlandırma',
      'Bu anlaşmayı erken sonlandırmak istediğinize emin misiniz?',
      'warning'
    );
    
    if (result) {
      try {
        // Mark the agreement as inactive
        const updatedAgreement = { ...agreement, status: 'inactive' };
        const savedAgreement = await updateAgreement(agreement.id, updatedAgreement);
        
        if (savedAgreement) {
          // Update in state
          setAgreements(agreements.map(a => 
            a.id === agreement.id ? savedAgreement : a
          ));
          
          // Mark associated company as inactive
          const company = companies.find(c => String(c.id) === String(agreement.companyId));
          if (company && company.status === 'active') {
            const updatedCompany = { ...company, status: 'inactive' };
            const savedCompany = await updateCompany(company.id, updatedCompany);
            if (savedCompany) {
              setCompanies(companies.map(c => 
                c.id === company.id ? savedCompany : c
              ));
            }
          }
          
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma erken sonlandırıldı: ${getCompanyName(agreement.companyId)} (ID: ${agreement.id})`
          });
          
          // Show success message
          await window.showAlert(
            'Başarılı',
            'Anlaşma erken sonlandırıldı ve firma pasif duruma getirildi.',
            'success'
          );
        }
      } catch (error) {
        console.error('Error terminating agreement:', error);
        await window.showAlert(
          'Hata',
          'Anlaşma erken sonlandırılırken bir hata oluştu.',
          'error'
        );
      }
    }
  };

  const handleFormChange = (e) => {
    const { name, value } = e.target;
    setFormData({
      ...formData,
      [name]: value
    });
    
    // When date changes, we might need to update available panels
    if (name === 'startDate' || name === 'endDate') {
      // This would require updating the UI to show new available panels
      // We'll handle this in the render part
    }
  };

  const handleSiteSelection = (siteId) => {
    if (selectedSites.includes(siteId)) {
      // Remove site from selection
      setSelectedSites(selectedSites.filter(id => id !== siteId));
      // Remove panel count for this site
      const newSitePanelCounts = { ...sitePanelCounts };
      delete newSitePanelCounts[siteId];
      setSitePanelCounts(newSitePanelCounts);
      
      // Remove block and panel selections for this site
      const newBlockSelections = { ...siteBlockSelections };
      delete newBlockSelections[siteId];
      setSiteBlockSelections(newBlockSelections);
      
      const newPanelSelections = { ...sitePanelSelections };
      delete newPanelSelections[siteId];
      setSitePanelSelections(newPanelSelections);
    } else {
      // Add site to selection
      setSelectedSites([...selectedSites, siteId]);
      // Initialize panel count for this site
      setSitePanelCounts({
        ...sitePanelCounts,
        [siteId]: 0
      });
      
      // Initialize block and panel selections for this site
      setSiteBlockSelections(prev => ({ ...prev, [siteId]: [] }));
      setSitePanelSelections(prev => ({ ...prev, [siteId]: {} }));
      
      // Show info about panel availability if weeks are selected
      if (selectedWeeks.length > 0) {
        const { startDate, endDate } = getCurrentDateRange();
        const site = sites.find(s => s.id === siteId);
        if (site) {
          const blockCount = parseInt(site.blocks) || 0;
          const elevatorsPerBlock = parseInt(site.elevatorsPerBlock) || 0;
          const totalPanels = blockCount * elevatorsPerBlock * 2;
          
          let unavailablePanels = 0;
          for (let blockIndex = 0; blockIndex < blockCount; blockIndex++) {
            const blockId = `block-${blockIndex}`;
            for (let panelIndex = 0; panelIndex < elevatorsPerBlock * 2; panelIndex++) {
              const panelId = `panel-${panelIndex}`;
              if (!isPanelAvailable(siteId, blockId, panelId, startDate, endDate)) {
                unavailablePanels++;
              }
            }
          }
          
          if (unavailablePanels > 0) {
            showAlertModal(
              'Panel Kullanılabilirlik Bilgisi',
              `${site.name} sitesinde ${totalPanels} panelin ${unavailablePanels} tanesi seçilen tarih aralığında başka anlaşmalarda kullanılmaktadır.`,
              'info'
            );
          }
        }
      }
    }
  };

  // Generate block labels (A, B, C, etc.)
  const generateBlockLabels = (blockCount) => {
    const labels = [];
    for (let i = 0; i < blockCount; i++) {
      labels.push(String.fromCharCode(65 + i)); // A, B, C, etc.
    }
    return labels;
  };

  // Handle block selection for a site
  const handleBlockSelection = (siteId, blockId) => {
    const currentSelections = siteBlockSelections[siteId] || [];
    let newSelections;
    
    if (currentSelections.includes(blockId)) {
      // Remove block
      newSelections = currentSelections.filter(id => id !== blockId);
      
      // Remove panel selections for this block
      const newPanelSelections = { ...sitePanelSelections };
      if (newPanelSelections[siteId]) {
        delete newPanelSelections[siteId][blockId];
        setSitePanelSelections(newPanelSelections);
      }
    } else {
      // Add block
      newSelections = [...currentSelections, blockId];
      
      // Initialize panel selections for this block
      setSitePanelSelections(prev => ({
        ...prev,
        [siteId]: {
          ...prev[siteId],
          [blockId]: []
        }
      }));
    }
    
    setSiteBlockSelections(prev => ({ ...prev, [siteId]: newSelections }));
    
    // Update total panel count for the site (with a slight delay to ensure state is updated)
    setTimeout(() => updateSitePanelCount(siteId), 0);
  };

  // Handle panel selection within a block
  const handlePanelSelection = (siteId, blockId, panelId) => {
    // Check if panel is available for the selected date range
    const { startDate, endDate } = getCurrentDateRange();
    if (!isPanelAvailable(siteId, blockId, panelId, startDate, endDate)) {
      // Show alert that panel is not available
      showAlertModal(
        'Panel Kullanımda',
        'Bu panel seçilen tarih aralığında başka bir anlaşmada kullanılmaktadır.',
        'warning'
      );
      return;
    }
    
    const currentSelections = (sitePanelSelections[siteId] && sitePanelSelections[siteId][blockId]) || [];
    let newSelections;
    
    if (currentSelections.includes(panelId)) {
      // Remove panel
      newSelections = currentSelections.filter(id => id !== panelId);
    } else {
      // Add panel
      newSelections = [...currentSelections, panelId];
    }
    
    setSitePanelSelections(prev => ({
      ...prev,
      [siteId]: {
        ...prev[siteId],
        [blockId]: newSelections
      }
    }));
    
    // Update total panel count for the site
    updateSitePanelCount(siteId);
  };

  // Get information about which agreement is using a specific panel
  const getPanelUsageInfo = (siteId, blockId, panelId, startDate, endDate) => {
    if (!startDate || !endDate) return null;
    
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId) &&
      agreement.status === 'active'
    );
    
    const newStart = new Date(startDate);
    const newEnd = new Date(endDate);
    
    for (const agreement of siteAgreements) {
      const existingStart = new Date(agreement.startDate);
      const existingEnd = new Date(agreement.endDate);
      
      if (dateRangesOverlap(newStart, newEnd, existingStart, existingEnd)) {
        if (agreement.siteBlockSelections && agreement.siteBlockSelections[siteId]) {
          const usedBlocks = agreement.siteBlockSelections[siteId];
          if (usedBlocks.includes(blockId)) {
            if (agreement.sitePanelSelections && 
                agreement.sitePanelSelections[siteId] && 
                agreement.sitePanelSelections[siteId][blockId] &&
                agreement.sitePanelSelections[siteId][blockId].includes(panelId)) {
              return {
                agreementId: agreement.id,
                companyName: getCompanyName(agreement.companyId),
                startDate: agreement.startDate,
                endDate: agreement.endDate
              };
            }
          }
        }
      }
    }
    
    return null;
  };

  // Check if a specific panel is available for the selected date range
  const isPanelAvailable = (siteId, blockId, panelId, startDate, endDate) => {
    if (!startDate || !endDate) return true;
    
    // Find all active agreements that include this site
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId) &&
      agreement.status === 'active'
    );
    
    const newStart = new Date(startDate);
    const newEnd = new Date(endDate);
    
    // Check each existing agreement for date overlap and panel usage
    for (const agreement of siteAgreements) {
      const existingStart = new Date(agreement.startDate);
      const existingEnd = new Date(agreement.endDate);
      
      // Check if date ranges overlap
      if (dateRangesOverlap(newStart, newEnd, existingStart, existingEnd)) {
        // Check if this specific panel is used in the overlapping agreement
        if (agreement.siteBlockSelections && agreement.siteBlockSelections[siteId]) {
          const usedBlocks = agreement.siteBlockSelections[siteId];
          if (usedBlocks.includes(blockId)) {
            // Check if this specific panel is used in this block
            if (agreement.sitePanelSelections && 
                agreement.sitePanelSelections[siteId] && 
                agreement.sitePanelSelections[siteId][blockId] &&
                agreement.sitePanelSelections[siteId][blockId].includes(panelId)) {
              return false; // Panel is not available
            }
          }
        }
      }
    }
    
    return true; // Panel is available
  };

  // Get the current date range for availability checking
  const getCurrentDateRange = () => {
    const selectedWeekObjects = generateWeekOptions().filter(week => selectedWeeks.includes(week.id));
    if (selectedWeekObjects.length === 0) {
      return { startDate: formData.startDate, endDate: formData.endDate };
    }
    
    return {
      startDate: selectedWeekObjects[0].start,
      endDate: selectedWeekObjects[selectedWeekObjects.length - 1].end
    };
  };

  // Update the total panel count for a site based on selected panels
  const updateSitePanelCount = (siteId) => {
    const siteSelections = sitePanelSelections[siteId] || {};
    let totalSelectedPanels = 0;
    
    Object.values(siteSelections).forEach(blockPanels => {
      if (Array.isArray(blockPanels)) {
        totalSelectedPanels += blockPanels.length;
      }
    });
    
    setSitePanelCounts(prev => ({ ...prev, [siteId]: totalSelectedPanels }));
  };

  const handlePanelCountChange = (siteId, value) => {
    setSitePanelCounts({
      ...sitePanelCounts,
      [siteId]: value
    });
  };

  // Calculate total panels
  const calculateTotalPanels = () => {
    return Object.values(sitePanelCounts).reduce((total, count) => {
      const panelCount = parseInt(count) || 0;
      return total + panelCount;
    }, 0);
  };

  // Calculate total weeks
  const calculateTotalWeeks = () => {
    if (!formData.startDate || !formData.endDate) return 0;
    
    const start = new Date(formData.startDate);
    const end = new Date(formData.endDate);
    
    // Calculate difference in days
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // Convert to weeks (rounded up)
    return Math.ceil(diffDays / 7);
  };

  // Calculate total agreement amount
  const calculateTotalAmount = () => {
    const totalPanels = calculateTotalPanels();
    const totalWeeks = calculateTotalWeeks();
    const weeklyRate = parseFloat(formData.weeklyRatePerPanel) || 0;
    
    return totalPanels * totalWeeks * weeklyRate;
  };

  const handleFormSubmit = async (e) => {
    e.preventDefault();
    
    // Form validation
    if (!formData.companyId || !formData.startDate || !formData.endDate || !formData.weeklyRatePerPanel) {
      await window.showAlert(
        'Eksik Bilgi',
        'Lütfen zorunlu alanları doldurunuz.',
        'warning'
      );
      return;
    }
    
    // Generate week options to ensure we have the correct week IDs
    const weekOptions = generateWeekOptions();
    
    // Check if weeks are selected
    if (selectedWeeks.length === 0) {
      await window.showAlert(
        'Eksik Bilgi',
        'Lütfen en az bir hafta seçiniz.',
        'warning'
      );
      return;
    }
    
    // Check if sites are selected
    if (selectedSites.length === 0) {
      await window.showAlert(
        'Eksik Bilgi',
        'Lütfen en az bir site seçiniz.',
        'warning'
      );
      return;
    }
    
    // Check if all selected sites have panel counts
    for (const siteId of selectedSites) {
      const panelCount = parseInt(sitePanelCounts[siteId]) || 0;
      
      if (panelCount === 0) {
        await window.showAlert(
          'Eksik Bilgi',
          'Lütfen tüm seçilen siteler için en az bir panel seçiniz.',
          'warning'
        );
        return;
      }
      
      // Check available panels for the selected weeks
      const selectedWeekObjects = generateWeekOptions().filter(week => selectedWeeks.includes(week.id));
      const availablePanels = calculateAvailablePanelsForWeeks(siteId, selectedWeekObjects);
      if (panelCount > availablePanels) {
        const site = sites.find(s => s.id === siteId);
        await window.showAlert(
          'Yetersiz Panel',
          `${site.name} için sadece ${availablePanels} panel seçilebilir. Seçilen haftalarda ${panelCount - availablePanels} panel fazla seçildi.`,
          'warning'
        );
        return;
      }
    }
    
    try {
      // Calculate the actual start and end dates based on selected weeks
      const selectedWeekObjects = weekOptions.filter(week => selectedWeeks.includes(week.id));
      const actualStartDate = selectedWeekObjects.length > 0 
        ? selectedWeekObjects[0].start 
        : formData.startDate;
      const actualEndDate = selectedWeekObjects.length > 0 
        ? selectedWeekObjects[selectedWeekObjects.length - 1].end 
        : formData.endDate;
      
      // Prepare agreement data
      const agreementData = {
        ...formData,
        startDate: actualStartDate,
        endDate: actualEndDate,
        siteIds: selectedSites,
        sitePanelCounts: sitePanelCounts,
        siteBlockSelections: siteBlockSelections, // Save block selections
        sitePanelSelections: sitePanelSelections, // Save panel selections
        totalPanels: calculateTotalPanels(),
        totalWeeks: selectedWeeks.length,
        totalAmount: calculateTotalAmount(),
        status: 'active',
        isPaid: false // New agreements are not paid by default
      };
      
      // Get company name for logging
      const company = companies.find(c => c.id === formData.companyId);
      const companyName = company ? company.name : 'Bilinmeyen Firma';
      
      if (currentAgreement) {
        // Update existing agreement
        const updatedAgreement = await updateAgreement(currentAgreement.id, agreementData);
        if (updatedAgreement) {
          setAgreements(agreements.map(agreement => agreement.id === currentAgreement.id ? updatedAgreement : agreement));
          setShowAddForm(false);
          setCurrentAgreement(null);
          setSelectedSites([]);
          setSitePanelCounts({});
          setSelectedWeeks([]);
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Anlaşma güncellendi: ${companyName}`
          });
          
          await window.showAlert(
            'Başarılı',
            'Anlaşma başarıyla güncellendi.',
            'success'
          );
        } else {
          throw new Error('Anlaşma güncellenemedi');
        }
      } else {
        // Create new agreement
        const newAgreement = await createAgreement(agreementData);
        if (newAgreement) {
          setAgreements([...agreements, newAgreement]);
          setShowAddForm(false);
          setSelectedSites([]);
          setSitePanelCounts({});
          setSelectedWeeks([]);
          // Log the action
          await createLog({
            user: 'Admin',
            action: `Yeni anlaşma eklendi: ${companyName} (${calculateTotalPanels()} panel, ${formatCurrency(calculateTotalAmount())})`
          });
          
          await window.showAlert(
            'Başarılı',
            'Yeni anlaşma başarıyla eklendi.',
            'success'
          );
        } else {
          throw new Error('Anlaşma oluşturulamadı');
        }
      }
    } catch (error) {
      console.error('Error saving agreement:', error);
      await window.showAlert(
        'Hata',
        'Anlaşma kaydedilirken bir hata oluştu: ' + error.message,
        'error'
      );
    }
  };

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount);
  };

  // Get company name by ID
  const getCompanyName = (companyId) => {
    // Handle both string and number IDs by converting to string for comparison
    const company = companies.find(c => String(c.id) === String(companyId));
    return company ? company.name : 'Bilinmeyen Firma';
  };

  // Get site name by ID
  const getSiteName = (siteId) => {
    // Handle both string and number IDs by converting to string for comparison
    const site = sites.find(s => String(s.id) === String(siteId));
    return site ? site.name : '';
  };

  // Calculate available panels for a site during a specific date range
  const calculateAvailablePanels = (siteId, startDate, endDate) => {
    // If no date range is provided, return the site's total panels
    if (!startDate || !endDate) {
      const site = sites.find(s => s.id === siteId);
      return site ? site.panels : 0;
    }
    
    // Find all agreements that include this site
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId)
    );
    
    // Parse the new agreement dates
    const newStart = new Date(startDate);
    const newEnd = new Date(endDate);
    
    // Calculate total panels for the site
    const site = sites.find(s => s.id === siteId);
    const totalPanels = site ? site.panels : 0;
    
    // Track used panels for overlapping weeks
    let usedPanels = 0;
    
    // Check each existing agreement for date overlap
    for (const agreement of siteAgreements) {
      // Parse existing agreement dates
      const existingStart = new Date(agreement.startDate);
      const existingEnd = new Date(agreement.endDate);
      
      // Check if date ranges overlap
      if (newStart <= existingEnd && newEnd >= existingStart) {
        // There is an overlap, add the panels used in that agreement
        const panelsInAgreement = parseInt(agreement.sitePanelCounts[siteId]) || 0;
        usedPanels = Math.max(usedPanels, panelsInAgreement);
      }
    }
    
    // Return available panels (total - used)
    return Math.max(0, totalPanels - usedPanels);
  };

  // Get week ranges for an agreement
  const getWeekRanges = (startDate, endDate) => {
    if (!startDate || !endDate) return [];
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    const weeks = [];
    
    // Calculate the number of weeks
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const weekCount = Math.ceil(diffDays / 7);
    
    // Generate week ranges
    for (let i = 0; i < weekCount; i++) {
      const weekStart = new Date(start);
      weekStart.setDate(start.getDate() + (i * 7));
      
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      // Make sure we don't go beyond the end date
      if (weekEnd > end) {
        weeks.push({ start: weekStart, end });
      } else {
        weeks.push({ start: weekStart, end: weekEnd });
      }
    }
    
    return weeks;
  };

  // Check if two date ranges overlap
  const dateRangesOverlap = (start1, end1, start2, end2) => {
    return start1 <= end2 && start2 <= end1;
  };

  // Calculate available panels for a site during a specific date range (improved version)
  const calculateAvailablePanelsImproved = (siteId, startDate, endDate) => {
    // If no date range is provided, return the site's total panels
    if (!startDate || !endDate) {
      const site = sites.find(s => s.id === siteId);
      return site ? site.panels : 0;
    }
    
    // Find all agreements that include this site
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId) &&
      agreement.status === 'active' // Only consider active agreements
    );
    
    // Parse the new agreement dates
    const newStart = new Date(startDate);
    const newEnd = new Date(endDate);
    
    // Calculate total panels for the site
    const site = sites.find(s => s.id === siteId);
    const totalPanels = site ? site.panels : 0;
    
    // Track maximum panels used in any overlapping week
    let maxUsedPanels = 0;
    
    // Check each existing agreement for date overlap
    for (const agreement of siteAgreements) {
      // Parse existing agreement dates
      const existingStart = new Date(agreement.startDate);
      const existingEnd = new Date(agreement.endDate);
      
      // Check if date ranges overlap
      if (dateRangesOverlap(newStart, newEnd, existingStart, existingEnd)) {
        // There is an overlap, get the panels used in that agreement
        const panelsInAgreement = parseInt(agreement.sitePanelCounts[siteId]) || 0;
        maxUsedPanels = Math.max(maxUsedPanels, panelsInAgreement);
      }
    }
    
    // Return available panels (total - used)
    return Math.max(0, totalPanels - maxUsedPanels);
  };

  // Generate week options based on start and end dates
  const generateWeekOptions = () => {
    if (!formData.startDate || !formData.endDate) return [];
    
    const start = new Date(formData.startDate);
    const end = new Date(formData.endDate);
    const weeks = [];
    
    // Calculate the number of weeks
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const weekCount = Math.ceil(diffDays / 7);
    
    // Generate week options
    for (let i = 0; i < weekCount; i++) {
      const weekStart = new Date(start);
      weekStart.setDate(start.getDate() + (i * 7));
      
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      // Make sure we don't go beyond the end date
      if (weekEnd > end) {
        weekEnd.setTime(end.getTime());
      }
      
      weeks.push({
        id: i + 1,
        label: `${weekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')}`,
        start: weekStart.toISOString().split('T')[0],
        end: weekEnd.toISOString().split('T')[0]
      });
    }
    
    return weeks;
  };

  // Handle week selection
  const handleWeekSelection = (weekId) => {
    let newSelectedWeeks;
    if (selectedWeeks.includes(weekId)) {
      newSelectedWeeks = selectedWeeks.filter(id => id !== weekId);
    } else {
      newSelectedWeeks = [...selectedWeeks, weekId];
    }
    
    setSelectedWeeks(newSelectedWeeks);
    
    // Check if this week selection affects panel availability
    if (newSelectedWeeks.length > 0 && selectedSites.length > 0) {
      const weekOptions = generateWeekOptions();
      const selectedWeekObjects = weekOptions.filter(week => newSelectedWeeks.includes(week.id));
      const startDate = selectedWeekObjects[0]?.start;
      const endDate = selectedWeekObjects[selectedWeekObjects.length - 1]?.end;
      
      // Clear any panel selections that are no longer available
      let hasUnavailablePanels = false;
      const newPanelSelections = { ...sitePanelSelections };
      
      for (const siteId of selectedSites) {
        if (newPanelSelections[siteId]) {
          for (const blockId in newPanelSelections[siteId]) {
            const selectedPanels = newPanelSelections[siteId][blockId] || [];
            const availablePanels = selectedPanels.filter(panelId => 
              isPanelAvailable(siteId, blockId, panelId, startDate, endDate)
            );
            
            if (availablePanels.length < selectedPanels.length) {
              hasUnavailablePanels = true;
              newPanelSelections[siteId][blockId] = availablePanels;
            }
          }
        }
      }
      
      if (hasUnavailablePanels) {
        setSitePanelSelections(newPanelSelections);
        // Update panel counts
        selectedSites.forEach(siteId => updateSitePanelCount(siteId));
        
        showAlertModal(
          'Panel Kullanılabilirliği Değişti',
          'Seçilen tarih aralığında bazı paneller başka anlaşmalarda kullanıldığı için seçimden çıkarıldı.',
          'warning'
        );
      }
    }
  };

  // Calculate available panels for a site during specific weeks
  const calculateAvailablePanelsForWeeks = (siteId, weeks) => {
    if (!weeks || weeks.length === 0) {
      const site = sites.find(s => s.id === siteId);
      return site ? site.panels : 0;
    }
    
    // Find all agreements that include this site
    const siteAgreements = agreements.filter(agreement => 
      agreement.siteIds && agreement.siteIds.includes(siteId) &&
      agreement.status === 'active'
    );
    
    // Calculate total panels for the site
    const site = sites.find(s => s.id === siteId);
    const totalPanels = site ? site.panels : 0;
    
    // Track maximum panels used in any selected week
    let maxUsedPanels = 0;
    
    // Check each selected week
    for (const week of weeks) {
      const weekStart = new Date(week.start);
      const weekEnd = new Date(week.end);
      
      // Check each existing agreement for date overlap with this week
      for (const agreement of siteAgreements) {
        const existingStart = new Date(agreement.startDate);
        const existingEnd = new Date(agreement.endDate);
        
        // Check if this week overlaps with the existing agreement
        if (dateRangesOverlap(weekStart, weekEnd, existingStart, existingEnd)) {
          // There is an overlap, get the panels used in that agreement
          const panelsInAgreement = parseInt(agreement.sitePanelCounts[siteId]) || 0;
          maxUsedPanels = Math.max(maxUsedPanels, panelsInAgreement);
        }
      }
    }
    
    // Return available panels (total - used)
    return Math.max(0, totalPanels - maxUsedPanels);
  };

  if (loading) {
    return (
      <main className="d-flex justify-content-center align-items-center min-vh-100">
        <div className="text-center">
          <div className="loading-spinner mx-auto"></div>
          <p className="mt-3 text-muted">Anlaşmalar yükleniyor...</p>
        </div>
      </main>
    );
  }

  return (
    <main className="container-fluid py-4">
      <header className="d-flex justify-content-between align-items-center mb-4">
        <h1 className="h3 fw-bold">Anlaşmalar</h1>
        <button 
          onClick={handleAddAgreement}
          className="btn btn-primary-gradient btn-icon"
          aria-label="Yeni Anlaşma Ekle"
        >
          <i className="bi bi-plus-lg" aria-hidden="true"></i>
          Anlaşma Ekle
        </button>
      </header>

      {/* Agreements Table */}
      <section className="card custom-card shadow-sm">
        <div className="card-body">
          <div className="table-responsive">
            <table className="table custom-table" aria-label="Anlaşma Listesi">
              <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Şirket</th>
                  <th scope="col">Toplam Panel</th>
                  <th scope="col">Toplam Hafta</th>
                  <th scope="col">Haftalık Tutar</th>
                  <th scope="col">Toplam Tutar</th>
                  <th scope="col">Başlangıç</th>
                  <th scope="col">Bitiş</th>
                  <th scope="col">Durum</th>
                  <th scope="col">İşlemler</th>
                </tr>
              </thead>
              <tbody>
                {agreements.map((agreement) => (
                  <tr key={agreement.id}>
                    <td>{agreement.id}</td>
                    <td className="fw-medium">{getCompanyName(agreement.companyId)}</td>
                    <td>{agreement.totalPanels}</td>
                    <td>{agreement.totalWeeks}</td>
                    <td>{formatCurrency(agreement.weeklyRatePerPanel)}</td>
                    <td>{formatCurrency(agreement.totalAmount)}</td>
                    <td>{agreement.startDate}</td>
                    <td>{agreement.endDate}</td>
                    <td>
                      <span className={`badge ${agreement.status === 'active' ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}`}>
                        {agreement.status === 'active' ? 'Aktif' : 'Pasif'}
                      </span>
                    </td>
                    <td>
                      <div className="d-flex gap-2">
                        <button
                          onClick={() => handleShowAgreement(agreement)}
                          className="btn btn-sm btn-outline-primary"
                          title="Göster"
                          aria-label={`Anlaşma detaylarını göster: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-eye" aria-hidden="true"></i>
                        </button>
                        <button
                          onClick={() => handleEditAgreement(agreement)}
                          className="btn btn-sm btn-outline-secondary"
                          title="Düzenle"
                          aria-label={`Anlaşmayı düzenle: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-pencil" aria-hidden="true"></i>
                        </button>
                        <button
                          onClick={() => handlePaymentAgreement(agreement)}
                          className={`btn btn-sm ${agreement.isPaid ? 'btn-success' : 'btn-primary'}`}
                          title={agreement.isPaid ? "Ödeme Alındı" : "Ödeme"}
                          disabled={agreement.isPaid}
                          aria-label={agreement.isPaid ? `Ödeme alındı: ${getCompanyName(agreement.companyId)}` : `Ödeme al: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-currency-dollar" aria-hidden="true"></i>
                        </button>
                        <button
                          onClick={() => handleRenewAgreement(agreement)}
                          className="btn btn-sm btn-outline-info"
                          title="Anlaşmayı Yenile"
                          disabled={agreement.status === 'active'}
                          aria-label={`Anlaşmayı yenile: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-arrow-repeat" aria-hidden="true"></i>
                        </button>
                        <button
                          onClick={() => handleTerminateAgreement(agreement)}
                          className="btn btn-sm btn-outline-danger"
                          title="Erken Sonlandır"
                          disabled={agreement.status !== 'active'}
                          aria-label={`Anlaşmayı erken sonlandır: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-x-circle" aria-hidden="true"></i>
                        </button>
                        <button
                          onClick={() => handleArchiveAgreement(agreement.id)}
                          className="btn btn-sm btn-outline-warning"
                          title="Arşivle"
                          aria-label={`Anlaşmayı arşivle: ${getCompanyName(agreement.companyId)}`}
                        >
                          <i className="bi bi-archive" aria-hidden="true"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {agreements.length === 0 && (
                  <tr>
                    <td colSpan="9" className="text-center py-5">
                      <div className="empty-state">
                        <i className="bi bi-handshake" aria-hidden="true"></i>
                        <p className="mb-3">Henüz anlaşma bulunmamaktadır.</p>
                        <button 
                          onClick={handleAddAgreement}
                          className="btn btn-primary-gradient"
                        >
                          Anlaşma Ekle
                        </button>
                      </div>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </section>

      {/* Agreement Detail Modal */}
      {showModal && currentAgreement && (
        <div className="modal fade show d-block" id="agreementDetailModal" tabIndex="-1" aria-labelledby="agreementDetailModalLabel" aria-modal="true" role="dialog" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-lg" role="document">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title" id="agreementDetailModalLabel">{getCompanyName(currentAgreement.companyId)} - Anlaşma Detayı</h5>
                <button
                  type="button"
                  className="btn-close"
                  onClick={handleCloseModal}
                  aria-label="Close"
                ></button>
              </div>
              <div className="modal-body">
                <div className="row mb-4">
                  <div className="col-md-6">
                    <h6 className="fw-medium mb-3">Anlaşma Bilgileri</h6>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Şirket:</strong></div>
                      <div className="col-sm-7">{getCompanyName(currentAgreement.companyId)}</div>
                    </div>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Toplam Panel:</strong></div>
                      <div className="col-sm-7">{currentAgreement.totalPanels}</div>
                    </div>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Toplam Hafta:</strong></div>
                      <div className="col-sm-7">{currentAgreement.totalWeeks}</div>
                    </div>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Haftalık Tutar:</strong></div>
                      <div className="col-sm-7">{formatCurrency(currentAgreement.weeklyRatePerPanel)}</div>
                    </div>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Toplam Tutar:</strong></div>
                      <div className="col-sm-7">{formatCurrency(currentAgreement.totalAmount)}</div>
                    </div>
                    <div className="row mb-2">
                      <div className="col-sm-5"><strong>Başlangıç:</strong></div>
                      <div className="col-sm-7">{currentAgreement.startDate}</div>
                    </div>
                    <div className="row">
                      <div className="col-sm-5"><strong>Bitiş:</strong></div>
                      <div className="col-sm-7">{currentAgreement.endDate}</div>
                    </div>
                    <div className="row">
                      <div className="col-sm-5"><strong>Ödeme Durumu:</strong></div>
                      <div className="col-sm-7">
                        <span className={`badge ${currentAgreement.isPaid ? 'bg-success-subtle text-success-emphasis' : 'bg-warning-subtle text-warning-emphasis'}`}>
                          {currentAgreement.isPaid ? 'Ödeme Alındı' : 'Ödeme Bekleniyor'}
                        </span>
                      </div>
                    </div>

                  </div>
                  
                  <div className="col-md-6">
                    <h6 className="fw-medium mb-3">Siteler</h6>
                    <ul className="list-group">
                      {currentAgreement.siteIds && currentAgreement.siteIds.map((siteId, index) => (
                        <li key={index} className="list-group-item d-flex justify-content-between align-items-center">
                          <span>{getSiteName(siteId)}</span>
                          <span className="badge bg-primary rounded-pill">
                            {currentAgreement.sitePanelCounts && currentAgreement.sitePanelCounts[siteId] 
                              ? currentAgreement.sitePanelCounts[siteId] 
                              : 0} panel
                          </span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
              <div className="modal-footer">
                <button
                  type="button"
                  className="btn btn-secondary"
                  onClick={() => {
                    handleCloseModal();
                  }}
                >
                  Kapat
                </button>
                <button
                  onClick={() => {
                    handleCloseModal();
                    handleTerminateAgreement(currentAgreement);
                  }}
                  className="btn btn-danger"
                  disabled={currentAgreement.status !== 'active'}
                >
                  Anlaşmayı Erken Sonlandır
                </button>
                <button 
                  className="btn btn-primary-gradient"
                  onClick={() => {
                    handleCloseModal();
                    handleEditAgreement(currentAgreement);
                  }}
                >
                  Düzenle
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Agreement Form Modal */}
      {showAddForm && (
        <div className="modal fade show d-block" id="agreementModal" tabIndex="-1" aria-labelledby="agreementModalLabel" aria-modal="true" role="dialog" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-xl" role="document">
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title h5 fw-bold" id="agreementModalLabel">
                  {currentAgreement ? 'Anlaşma Düzenle' : 'Yeni Anlaşma Ekle'}
                </h2>
                <button
                  type="button"
                  className="btn-close"
                  onClick={handleCloseAddForm}
                  aria-label="Kapat"
                ></button>
              </div>
              <div className="modal-body">
                <form onSubmit={handleFormSubmit} className="agreement-form" aria-labelledby="agreementModalLabel">
                  <main className="agreement-form-content">
                    {/* Company Selection */}
                    <section className="mb-4">
                      <header className="mb-3">
                        <h3 className="h6 fw-bold mb-2">Firma Bilgileri</h3>
                        <p className="text-muted small mb-0">Anlaşma yapılacak firmayı seçiniz</p>
                      </header>
                      <div className="row g-3">
                        <div className="col-md-6">
                          <div className="mb-3">
                            <label htmlFor="companyId" className="form-label fw-bold d-flex align-items-center">
                              Firma Seç 
                              <span className="text-danger ms-1" aria-label="zorunlu alan">*</span>
                            </label>
                            <select
                              id="companyId"
                              name="companyId"
                              value={formData.companyId}
                              onChange={handleFormChange}
                              className="form-select"
                              required
                              aria-describedby="companyHelp"
                            >
                              <option value="">Firma seçiniz</option>
                              {companies.map(company => (
                                <option key={company.id} value={company.id}>
                                  {company.name}
                                </option>
                              ))}
                            </select>
                            <div id="companyHelp" className="form-text">Anlaşma yapılacak firmayı seçiniz</div>
                          </div>
                        </div>
                      </div>
                    </section>
                    
                    {/* Date Range Selection */}
                    <section className="mb-4">
                      <header className="mb-3">
                        <h3 className="h6 fw-bold mb-2">Tarih Aralığı</h3>
                        <p className="text-muted small mb-0">Anlaşmanın başlangıç ve bitiş tarihlerini belirleyiniz</p>
                      </header>
                      <div className="row g-3">
                        <div className="col-md-6">
                          <div className="mb-3">
                            <label htmlFor="startDate" className="form-label fw-bold d-flex align-items-center">
                              Başlangıç Tarihi 
                              <span className="text-danger ms-1" aria-label="zorunlu alan">*</span>
                            </label>
                            <input
                              type="date"
                              id="startDate"
                              name="startDate"
                              value={formData.startDate}
                              onChange={handleFormChange}
                              className="form-control"
                              required
                              aria-describedby="dateHelp"
                            />
                            <div id="dateHelp" className="form-text">Anlaşmanın başlangıç tarihi</div>
                          </div>
                        </div>
                        
                        <div className="col-md-6">
                          <div className="mb-3">
                            <label htmlFor="endDate" className="form-label fw-bold d-flex align-items-center">
                              Bitiş Tarihi 
                              <span className="text-danger ms-1" aria-label="zorunlu alan">*</span>
                            </label>
                            <input
                              type="date"
                              id="endDate"
                              name="endDate"
                              value={formData.endDate}
                              onChange={handleFormChange}
                              className="form-control"
                              required
                              aria-describedby="endDateHelp"
                            />
                            <div id="endDateHelp" className="form-text">Anlaşmanın bitiş tarihi</div>
                          </div>
                        </div>
                      </div>
                    </section>
                    
                    {/* Week Selection */}
                    {formData.startDate && formData.endDate && (
                      <section className="mb-4">
                        <header className="mb-3">
                          <h3 className="h6 fw-bold mb-2">Hafta Seçimi</h3>
                          <p className="text-muted small mb-0">Anlaşma süresince kullanılacak haftaları seçiniz</p>
                        </header>
                        <div className="card border-primary-subtle">
                          <div className="card-header bg-primary-subtle">
                            <h4 className="mb-0 h6">Anlaşma Süresi</h4>
                          </div>
                          <div className="card-body">
                            <div className="mb-3">
                              <div className="row g-3" role="group" aria-label="Hafta seçenekleri">
                                {generateWeekOptions().map(week => (
                                  <div key={week.id} className="col-md-6 col-lg-4">
                                    <div className="form-check form-check-card">
                                      <input
                                        type="checkbox"
                                        id={`week-${week.id}`}
                                        className="form-check-input"
                                        checked={selectedWeeks.includes(week.id)}
                                        onChange={() => handleWeekSelection(week.id)}
                                        aria-describedby={`week-label-${week.id}`}
                                      />
                                      <label 
                                        className="form-check-label p-3 w-100" 
                                        htmlFor={`week-${week.id}`}
                                        id={`week-label-${week.id}`}
                                      >
                                        <div className="d-flex justify-content-between align-items-center">
                                          <span>{week.label}</span>
                                          <i className="bi bi-calendar-check" aria-hidden="true"></i>
                                        </div>
                                      </label>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                            {selectedWeeks.length === 0 && (
                              <div className="alert alert-warning" role="alert">
                                <i className="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
                                Lütfen en az bir hafta seçiniz.
                              </div>
                            )}
                          </div>
                        </div>
                      </section>
                    )}
                    
                    {/* Site Selection */}
                    {selectedWeeks.length > 0 && (
                      <section className="mb-4">
                        <header className="mb-3">
                          <h3 className="h6 fw-bold mb-2">Site Seçimi</h3>
                          <p className="text-muted small mb-0">Anlaşmaya dahil edilecek siteleri seçiniz</p>
                        </header>
                        <div className="card border-success-subtle">
                          <div className="card-header bg-success-subtle">
                            <h4 className="mb-0 h6">Anlaşmaya Dahil Edilecek Siteler</h4>
                          </div>
                          <div className="card-body">
                            <div className="mb-3">
                              <div className="row g-3" role="group" aria-label="Site seçenekleri">
                                {sites.map(site => (
                                  <div key={site.id} className="col-md-6 col-lg-4">
                                    <div className="form-check form-check-card">
                                      <input
                                        type="checkbox"
                                        id={`site-${site.id}`}
                                        className="form-check-input"
                                        checked={selectedSites.includes(site.id)}
                                        onChange={() => handleSiteSelection(site.id)}
                                        aria-describedby={`site-label-${site.id}`}
                                      />
                                      <label 
                                        className="form-check-label p-3 w-100" 
                                        htmlFor={`site-${site.id}`}
                                        id={`site-label-${site.id}`}
                                      >
                                        <div className="d-flex justify-content-between align-items-center">
                                          <span>{site.name}</span>
                                          <i className="bi bi-building" aria-hidden="true"></i>
                                        </div>
                                        <div className="small text-muted mt-1">
                                          <i className="bi bi-grid me-1" aria-hidden="true"></i>
                                          {site.panels} panel
                                        </div>
                                      </label>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      </section>
                    )}
                    
                    {/* Block and Panel Selection for Selected Sites */}
                    {selectedSites.length > 0 && (
                      <section className="mb-4">
                        <header className="mb-3">
                          <h3 className="h6 fw-bold mb-2">Blok ve Panel Seçimi</h3>
                          <p className="text-muted small mb-0">Her site için blokları ve panelleri seçiniz</p>
                        </header>
                        <div className="card border-info-subtle">
                          <div className="card-header bg-info-subtle">
                            <h4 className="mb-0 h6">Blok ve Panel Seçimi</h4>
                          </div>
                          <div className="card-body">
                            {/* Panel Status Legend */}
                            <div className="alert alert-info mb-3">
                              <h6 className="small fw-bold mb-2">
                                <i className="bi bi-info-circle me-1"></i>
                                Panel Durumu Açıklaması:
                              </h6>
                              <div className="row g-2 small">
                                <div className="col-auto">
                                  <span className="badge bg-primary me-1">1</span>
                                  Seçili Panel
                                </div>
                                <div className="col-auto">
                                  <span className="btn btn-sm btn-outline-secondary me-1" style={{ padding: '2px 6px', fontSize: '10px', lineHeight: '1' }}>2</span>
                                  Müsait Panel
                                </div>
                                <div className="col-auto">
                                  <span className="badge bg-danger me-1">
                                    3 <i className="bi bi-lock-fill ms-1" style={{ fontSize: '8px' }}></i>
                                  </span>
                                  Kullanımda (Başka anlaşmada)
                                </div>
                              </div>
                            </div>
                            
                            {selectedSites.map(siteId => {
                              const site = sites.find(s => s.id === siteId);
                              const blockCount = parseInt(site?.blocks) || 0;
                              const elevatorsPerBlock = parseInt(site?.elevatorsPerBlock) || 0;
                              const panelsPerBlock = elevatorsPerBlock * 2;
                              const blockLabels = generateBlockLabels(blockCount);
                              const selectedBlocks = siteBlockSelections[siteId] || [];
                              
                              return (
                                <div key={siteId} className="mb-4">
                                  <div className="border rounded p-3">
                                    <h5 className="h6 fw-bold mb-3">{site?.name || 'Bilinmeyen Site'}</h5>
                                    <div className="small text-muted mb-3">
                                      <i className="bi bi-info-circle me-1"></i>
                                      {blockCount} blok, blok başına {elevatorsPerBlock} asansör, {panelsPerBlock} panel
                                    </div>
                                    
                                    {/* Block Selection */}
                                    <div className="mb-3">
                                      <h6 className="small fw-bold mb-2">Blok Seçimi:</h6>
                                      <div className="row g-2">
                                        {blockLabels.map((blockLabel, blockIndex) => {
                                          const blockId = `block-${blockIndex}`;
                                          const isBlockSelected = selectedBlocks.includes(blockId);
                                          
                                          return (
                                            <div key={blockId} className="col-auto">
                                              <div className="form-check">
                                                <input
                                                  type="checkbox"
                                                  id={`${siteId}-${blockId}`}
                                                  className="form-check-input"
                                                  checked={isBlockSelected}
                                                  onChange={() => handleBlockSelection(siteId, blockId)}
                                                />
                                                <label 
                                                  className="form-check-label fw-bold"
                                                  htmlFor={`${siteId}-${blockId}`}
                                                >
                                                  {blockLabel} Blok
                                                </label>
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    
                                    {/* Panel Selection for Selected Blocks */}
                                    {selectedBlocks.length > 0 && (
                                      <div className="mb-3">
                                        <h6 className="small fw-bold mb-2">Panel Seçimi:</h6>
                                        {selectedBlocks.map(blockId => {
                                          const blockIndex = parseInt(blockId.split('-')[1]);
                                          const blockLabel = blockLabels[blockIndex];
                                          const selectedPanels = (sitePanelSelections[siteId] && sitePanelSelections[siteId][blockId]) || [];
                                          
                                          return (
                                            <div key={blockId} className="mb-3 p-2 border rounded bg-light">
                                              <div className="small fw-bold mb-2">{blockLabel} Blok Panelleri:</div>
                                              <div className="d-flex flex-wrap gap-1">
                                                {Array.from({ length: panelsPerBlock }, (_, panelIndex) => {
                                                  const panelId = `panel-${panelIndex}`;
                                                  const isPanelSelected = selectedPanels.includes(panelId);
                                                  const panelNumber = panelIndex + 1;
                                                  
                                                  // Check if panel is available for the selected date range
                                                  const { startDate, endDate } = getCurrentDateRange();
                                                  const isAvailable = isPanelAvailable(siteId, blockId, panelId, startDate, endDate);
                                                  
                                                  return (
                                                    <button
                                                      key={panelId}
                                                      type="button"
                                                      className={`btn btn-sm d-flex align-items-center justify-content-center ${
                                                        !isAvailable
                                                          ? 'btn-danger disabled'
                                                          : isPanelSelected 
                                                            ? 'btn-primary' 
                                                            : 'btn-outline-secondary'
                                                      }`}
                                                      onClick={() => handlePanelSelection(siteId, blockId, panelId)}
                                                      disabled={!isAvailable}
                                                      style={{ 
                                                        width: '40px', 
                                                        height: '40px', 
                                                        fontSize: '12px',
                                                        fontWeight: 'bold',
                                                        opacity: !isAvailable ? 0.6 : 1
                                                      }}
                                                      title={
                                                        !isAvailable 
                                                          ? (() => {
                                                              const usageInfo = getPanelUsageInfo(siteId, blockId, panelId, startDate, endDate);
                                                              return usageInfo 
                                                                ? `Panel ${panelNumber} - Kullanımda\nAnlaşma: ${usageInfo.companyName}\nTarih: ${usageInfo.startDate} - ${usageInfo.endDate}`
                                                                : `Panel ${panelNumber} - Kullanımda`;
                                                            })()
                                                          : `Panel ${panelNumber} - Müsait`
                                                      }
                                                    >
                                                      {panelNumber}
                                                      {!isAvailable && (
                                                        <i className="bi bi-lock-fill ms-1" style={{ fontSize: '8px' }}></i>
                                                      )}
                                                    </button>
                                                  );
                                                })}
                                              </div>
                                              <div className="small text-muted mt-1">
                                                Seçilen: {selectedPanels.length} / {panelsPerBlock} panel
                                              </div>
                                              
                                              {/* Panel availability info */}
                                              <div className="small mt-2">
                                                {(() => {
                                                  const { startDate, endDate } = getCurrentDateRange();
                                                  const availablePanels = Array.from({ length: panelsPerBlock }, (_, i) => `panel-${i}`)
                                                    .filter(panelId => isPanelAvailable(siteId, blockId, panelId, startDate, endDate));
                                                  const unavailablePanels = panelsPerBlock - availablePanels.length;
                                                  
                                                  return (
                                                    <div className="d-flex justify-content-between">
                                                      <span className="text-success">
                                                        <i className="bi bi-check-circle me-1"></i>
                                                        Müsait: {availablePanels.length}
                                                      </span>
                                                      {unavailablePanels > 0 && (
                                                        <span className="text-danger">
                                                          <i className="bi bi-lock me-1"></i>
                                                          Kullanımda: {unavailablePanels}
                                                        </span>
                                                      )}
                                                    </div>
                                                  );
                                                })()}
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                    )}
                                    
                                    {/* Site Total */}
                                    <div className="small">
                                      <strong>Bu site için toplam seçilen panel: {sitePanelCounts[siteId] || 0}</strong>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                            
                            {/* Total Panels Display */}
                            <div className="alert alert-info mt-4" role="alert">
                              <div className="d-flex justify-content-between align-items-center">
                                <span className="fw-bold">Toplam Panel Sayısı:</span>
                                <span className="fs-5 fw-bold">{calculateTotalPanels()}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </section>
                    )}
                    
                    {/* Weekly Rate and Summary */}
                    {selectedSites.length > 0 && (
                      <section className="mb-4">
                        <header className="mb-3">
                          <h3 className="h6 fw-bold mb-2">Anlaşma Bedeli</h3>
                          <p className="text-muted small mb-0">Anlaşma bedelini ve özeti belirleyiniz</p>
                        </header>
                        <div className="row g-4">
                          {/* Weekly Rate */}
                          <div className="col-md-6">
                            <div className="card h-100">
                              <div className="card-body">
                                <div className="mb-3">
                                  <label htmlFor="weeklyRatePerPanel" className="form-label fw-bold d-flex align-items-center">
                                    1 Haftalık 1 Pano için Anlaşma Rakamı (₺) 
                                    <span className="text-danger ms-1" aria-label="zorunlu alan">*</span>
                                  </label>
                                  <div className="input-group">
                                    <span className="input-group-text">₺</span>
                                    <input
                                      type="number"
                                      id="weeklyRatePerPanel"
                                      name="weeklyRatePerPanel"
                                      value={formData.weeklyRatePerPanel}
                                      onChange={handleFormChange}
                                      className="form-control"
                                      min="0"
                                      step="0.01"
                                      required
                                      aria-describedby="rateHelp"
                                    />
                                  </div>
                                  <div id="rateHelp" className="form-text">Her pano için haftalık anlaşma bedelini giriniz</div>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Total Weeks and Amount Display */}
                          {formData.weeklyRatePerPanel && (
                            <div className="col-md-6">
                              <div className="card h-100">
                                <div className="card-body">
                                  <h4 className="card-title h6 fw-bold mb-3">Anlaşma Özeti</h4>
                                  <div className="d-flex justify-content-between mb-2">
                                    <span>Seçilen Hafta Sayısı:</span>
                                    <span className="fw-bold">{selectedWeeks.length}</span>
                                  </div>
                                  <div className="d-flex justify-content-between mb-2">
                                    <span>Toplam Panel:</span>
                                    <span className="fw-bold">{calculateTotalPanels()}</span>
                                  </div>
                                  <hr />
                                  <div className="d-flex justify-content-between">
                                    <span className="fw-bold">Toplam Anlaşma Bedeli:</span>
                                    <span className="fw-bold text-success fs-5">{formatCurrency(calculateTotalAmount())}</span>
                                  </div>
                                  <div className="small text-muted mt-2">
                                    Hesaplama: {calculateTotalPanels()} panel × {selectedWeeks.length} hafta × {formatCurrency(formData.weeklyRatePerPanel)}
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      </section>
                    )}
                    
                    {/* Notes */}
                    <section className="mb-4">
                      <header className="mb-3">
                        <h3 className="h6 fw-bold mb-2">Notlar</h3>
                        <p className="text-muted small mb-0">Anlaşma ile ilgili ek notlarınızı buraya yazabilirsiniz</p>
                      </header>
                      <div className="mb-3">
                        <label htmlFor="notes" className="form-label fw-bold">Notlar</label>
                        <textarea
                          id="notes"
                          name="notes"
                          value={formData.notes}
                          onChange={handleFormChange}
                          className="form-control"
                          rows="4"
                          placeholder="Ek notlar..."
                          aria-describedby="notesHelp"
                        ></textarea>
                        <div id="notesHelp" className="form-text">Anlaşma ile ilgili eklemek istediğiniz notları buraya yazabilirsiniz</div>
                      </div>
                    </section>
                  </main>
                  
                  <footer className="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                    <button
                      type="button"
                      onClick={handleCloseAddForm}
                      className="btn btn-secondary"
                    >
                      <i className="bi bi-x-lg me-1" aria-hidden="true"></i>
                      İptal
                    </button>
                    <button
                      type="submit"
                      className="btn btn-primary-gradient"
                    >
                      <i className="bi bi-save me-1" aria-hidden="true"></i>
                      {currentAgreement ? 'Güncelle' : 'Anlaşmayı Kaydet'}
                    </button>
                  </footer>
                </form>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Custom Alert Modal */}
      {alertModal.show && (
        <div className="modal fade show d-block" id="alertModal" tabIndex="-1" aria-labelledby="alertModalLabel" aria-modal="true" role="dialog" style={{ backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1051 }}>
          <div className="modal-dialog modal-dialog-centered" role="document">
            <div className="modal-content">
              <div className={`modal-header ${alertModal.type === 'success' ? 'bg-success' : alertModal.type === 'warning' ? 'bg-warning' : alertModal.type === 'error' ? 'bg-danger' : 'bg-info'} text-white`}>
                <h5 className="modal-title" id="alertModalLabel">{alertModal.title}</h5>
                <button type="button" className="btn-close btn-close-white" onClick={closeAlertModal} aria-label="Close"></button>
              </div>
              <div className="modal-body">
                <p>{alertModal.message}</p>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-primary" onClick={closeAlertModal}>
                  Tamam
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* Delete All Agreements Button */}
      {agreements.length > 0 && (
        <div className="d-flex justify-content-end mt-3">
          <button
            onClick={handleDeleteAllAgreements}
            className="btn btn-danger"
            title="Tüm Anlaşmaları Sil"
          >
            <i className="bi bi-trash me-1"></i>
            Tüm Anlaşmaları Sil
          </button>
        </div>
      )}
    </main>
  );
};

export default Agreements;