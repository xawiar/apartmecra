rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper to get current user document
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserDoc() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user is admin
    function isAdmin() {
      // users koleksiyonundaki rol + email bazlı yedek kontrol
      return isAuthenticated() &&
             (
               (hasUserDoc() && getUserDoc().data.role == 'admin') ||
               (request.auth.token.email != null &&
                request.auth.token.email == 'admin@apartmecra.com') ||
               (request.auth.token.email != null &&
                request.auth.token.email.split('@')[0] == 'admin')
             );
    }

    function isCompanyUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'company_user';
    }

    function isSiteUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'site_user';
    }

    function isPersonnel() {
      return isAuthenticated() &&
             (
               // Email kontrolü önce (daha hızlı ve güvenilir)
               (request.auth.token.email != null && 
                request.auth.token.email.split('@').size() == 2 &&
                request.auth.token.email.split('@')[1] == 'personnel.local') ||
               // Users koleksiyonundaki role kontrolü
               (hasUserDoc() && getUserDoc().data.role == 'personnel')
             );
    }

    function getUserCompanyId() {
      // Önce users koleksiyonundaki companyId field'ını kontrol et
      return hasUserDoc() && getUserDoc().data.companyId != null 
        ? getUserDoc().data.companyId
        : (request.auth.token.email != null && 
           request.auth.token.email.split('@').size() == 2 && 
           request.auth.token.email.split('@')[1] == 'company.local')
          ? request.auth.token.email.split('@')[0]
          : null;
    }

    function getUserSiteId() {
      // Önce users koleksiyonundaki siteId field'ını kontrol et
      return hasUserDoc() && getUserDoc().data.siteId != null 
        ? getUserDoc().data.siteId
        : (request.auth.token.email != null && 
           request.auth.token.email.split('@').size() == 2 && 
           request.auth.token.email.split('@')[1] == 'site.local')
          ? request.auth.token.email.split('@')[0]
          : null;
    }
    
    // Users collection
    // GEÇİCİ OLARAK TÜM İŞLEMLER AÇIK - YENİDEN OLUŞTUR BUTONU İÇİN
    // Güvenlik için daha sonra sıkılaştırılmalı
    match /users/{userId} {
      allow read, write: if isAuthenticated();
    }
    
    // Sites collection
    match /sites/{siteId} {
      // Okuma: Authenticated kullanıcılar (email bazlı login de authenticated olur)
      // Site kullanıcıları kendi sitelerini görebilir
      allow read: if isAuthenticated();
      
      // Oluşturma: Admin veya personnel (personnel panel yönetimi yapıyor, site oluşturabilir)
      allow create: if isAdmin() || isPersonnel();
      
      // Güncelleme: Admin veya personnel (personnel site bilgilerini güncelleyebilir)
      // Site kullanıcıları artık direkt güncelleme yapamaz, onay mekanizması kullanılır
      allow update: if isAdmin() || isPersonnel();
      
      // Silme: Admin veya personnel (arşivleme için gerekli)
      allow delete: if isAdmin() || isPersonnel();
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Okuma: Authenticated kullanıcılar
      allow read: if isAuthenticated();
      
      // Oluşturma: Admin veya personnel (personnel panel yönetimi yapıyor, firma oluşturabilir)
      allow create: if isAdmin() || isPersonnel();
      
      // Güncelleme: Sadece admin (firma kullanıcıları artık direkt güncelleme yapamaz, onay mekanizması kullanılır)
      allow update: if isAdmin();
      
      // Silme: Admin veya personnel (arşivleme için gerekli)
      allow delete: if isAdmin() || isPersonnel();
    }
    
    // Agreements collection
    match /agreements/{agreementId} {
      // Okuma: Authenticated kullanıcılar
      // Not: Frontend'de role-based filtering yapılacak
      allow read: if isAuthenticated();
      
      // Oluşturma ve güncelleme: Authenticated kullanıcılar
      allow create, update: if isAuthenticated();
      
      // Silme: Sadece admin
      allow delete: if isAdmin();
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Debts collection
    match /debts/{debtId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Checks collection
    match /checks/{checkId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Site Update Requests collection
    match /siteUpdateRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Site kullanıcıları request oluşturabilir
      allow update, delete: if isAdmin(); // Sadece admin onaylayabilir/silebilir
    }
    
    // Company Update Requests collection
    match /companyUpdateRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Firma kullanıcıları request oluşturabilir
      allow update, delete: if isAdmin(); // Sadece admin onaylayabilir/silebilir
    }
    
    // Partners collection
    match /partners/{partnerId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Archived collections
    match /archivedSites/{siteId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedCompanies/{companyId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedAgreements/{agreementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Logs collection
    match /logs/{logId} {
      // Şu an için loglar tüm istemciler için açık; gerekirse ileride tekrar sıkılaştırılabilir.
      allow read, create, update, delete: if true;
    }
    
    // Panel images metadata
    match /panelImages/{imageId} {
      // Admin ve personel tüm görselleri okuyabilir
      // Firma kullanıcısı: sadece kendi companyId'sine ait görselleri görebilir
      // Site kullanıcısı: sadece kendi siteId'sine ait görselleri görebilir
      allow get: if isAdmin() ||
                  isPersonnel() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId()) ||
                  (isSiteUser() && resource.data.siteId == getUserSiteId()) ||
                  (isAuthenticated() && 
                   request.auth.token.email != null && 
                   (request.auth.token.email.split('@')[1] == 'company.local' || 
                    request.auth.token.email.split('@')[1] == 'site.local'));

      // List: Admin, personel, firma ve site kullanıcıları tüm görselleri listeleyebilir
      // Frontend'de filtreleme yapılacak
      // Email kontrolü ile company ve site kullanıcılarına da izin ver
      allow list: if isAdmin() || 
                    isPersonnel() ||
                    isCompanyUser() ||
                    isSiteUser() ||
                    (isAuthenticated() && 
                     request.auth.token.email != null && 
                     (request.auth.token.email.split('@')[1] == 'company.local' || 
                      request.auth.token.email.split('@')[1] == 'site.local'));

      // Yazma: sadece admin ve personel
      allow create, update, delete: if isAdmin() || isPersonnel();
    }
    
    // Agreement documents metadata
    match /agreementDocuments/{docId} {
      // Admin tüm dokümanları görebilir
      // Firma kullanıcısı sadece kendi anlaşmalarına ait dokümanları görebilmeli
      allow get: if isAdmin() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId());

      allow list: if isAdmin();

      // Yazma: sadece admin
      allow create, update, delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Okuma: Kullanıcılar sadece kendi bildirimlerini görebilir
      allow get: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || 
                     resource.data.userId == resource.id);
      
      // Liste: Kullanıcılar sadece kendi bildirimlerini listeleyebilir (userId filtresi ile)
      // Frontend'de userId filtresi uygulanacak
      allow list: if isAuthenticated();
      
      // Oluşturma: Admin ve personnel duyuru gönderebilir
      allow create: if isAdmin() || isPersonnel();
      
      // Güncelleme: Kullanıcılar sadece kendi bildirimlerini okuyabilir olarak işaretleyebilir
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        resource.data.userId == resource.id) &&
                       // Sadece read ve readAt alanlarını güncelleyebilir
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // Silme: Kullanıcılar sadece kendi bildirimlerini silebilir
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || 
                        resource.data.userId == resource.id);
    }
    
    // Default: deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}