rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper to get current user document
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserDoc() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user is admin
    function isAdmin() {
      // users koleksiyonundaki rol + email bazlı yedek kontrol
      return isAuthenticated() &&
             (
               (hasUserDoc() && getUserDoc().data.role == 'admin') ||
               (request.auth.token.email != null &&
                request.auth.token.email == 'admin@apartmecra.com')
             );
    }

    function isCompanyUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'company_user';
    }

    function isSiteUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'site_user';
    }

    function isPersonnel() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'personnel';
    }

    function getUserCompanyId() {
      return hasUserDoc() ? getUserDoc().data.companyId : null;
    }

    function getUserSiteId() {
      return hasUserDoc() ? getUserDoc().data.siteId : null;
    }
    
    // Users collection
    match /users/{userId} {
      // Kullanıcı listesi sadece admin'e açık
      allow list: if isAdmin();

      // Kendisini veya admin olan herkes görebilir
      allow get: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Yeni kullanıcılar backend (Functions) tarafından oluşturulmalı; frontend create kapalı
      allow create: if false;

      // Kullanıcı kendi profilini güncelleyebilir (sınırlı) veya admin her şeyi güncelleyebilir
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Silme sadece admin
      allow delete: if isAdmin();
    }
    
    // Sites collection
    match /sites/{siteId} {
      // NOTE: Şu an için işlevselliği engellememek adına tüm kullanıcılara açık.
      // Gerekirse ileride tekrar rol bazlı sıkılaştırılabilir.
      allow read: if true;
      allow create, update, delete: if true;
    }
    
    // Companies collection
    match /companies/{companyId} {
      allow read: if true;
      allow create, update, delete: if true;
    }
    
    // Agreements collection
    match /agreements/{agreementId} {
      allow read: if true;
      allow create, update, delete: if true;
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Partners collection
    match /partners/{partnerId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Archived collections
    match /archivedSites/{siteId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedCompanies/{companyId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedAgreements/{agreementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Logs collection
    match /logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Panel images metadata
    match /panelImages/{imageId} {
      // Admin ve personel tüm görselleri okuyabilir
      // Firma kullanıcısı: sadece kendi companyId'sine ait görselleri görebilir
      // Site kullanıcısı: sadece kendi siteId'sine ait görselleri görebilir
      allow get: if isAdmin() ||
                  isPersonnel() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId()) ||
                  (isSiteUser() && resource.data.siteId == getUserSiteId());

      allow list: if isAdmin() || isPersonnel();

      // Yazma: sadece admin ve personel
      allow create, update, delete: if isAdmin() || isPersonnel();
    }
    
    // Agreement documents metadata
    match /agreementDocuments/{docId} {
      // Admin tüm dokümanları görebilir
      // Firma kullanıcısı sadece kendi anlaşmalarına ait dokümanları görebilmeli
      allow get: if isAdmin() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId());

      allow list: if isAdmin();

      // Yazma: sadece admin
      allow create, update, delete: if isAdmin();
    }
    
    // Default: deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}