rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper to get current user document
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function hasUserDoc() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user is admin
    function isAdmin() {
      // users koleksiyonundaki rol + email bazlı yedek kontrol
      return isAuthenticated() &&
             (
               (hasUserDoc() && getUserDoc().data.role == 'admin') ||
               (request.auth.token.email != null &&
                request.auth.token.email == 'admin@apartmecra.com') ||
               (request.auth.token.email != null &&
                request.auth.token.email.split('@')[0] == 'admin')
             );
    }

    function isCompanyUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'company_user';
    }

    function isSiteUser() {
      return isAuthenticated() &&
             hasUserDoc() &&
             getUserDoc().data.role == 'site_user';
    }

    function isPersonnel() {
      return isAuthenticated() &&
             (
               (hasUserDoc() && getUserDoc().data.role == 'personnel') ||
               (request.auth.token.email != null && 
                request.auth.token.email.split('@')[1] == 'personnel.local')
             );
    }

    function getUserCompanyId() {
      return hasUserDoc() ? getUserDoc().data.companyId : null;
    }

    function getUserSiteId() {
      return hasUserDoc() ? getUserDoc().data.siteId : null;
    }
    
    // Users collection
    // GEÇİCİ OLARAK TÜM İŞLEMLER AÇIK - YENİDEN OLUŞTUR BUTONU İÇİN
    // Güvenlik için daha sonra sıkılaştırılmalı
    match /users/{userId} {
      allow read, write: if isAuthenticated();
    }
    
    // Sites collection
    match /sites/{siteId} {
      // Okuma: Authenticated kullanıcılar (email bazlı login de authenticated olur)
      // Site kullanıcıları kendi sitelerini görebilir
      allow read: if isAuthenticated();
      
      // Oluşturma ve silme: Sadece admin
      allow create, delete: if isAdmin();
      
      // Güncelleme: Admin veya site kullanıcısı kendi sitesini güncelleyebilir
      allow update: if isAdmin() || 
                    (isSiteUser() && 
                     (resource.data.id == getUserSiteId() || 
                      resource.data._docId == getUserSiteId() ||
                      resource.id == getUserSiteId()));
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Okuma: Authenticated kullanıcılar
      allow read: if isAuthenticated();
      
      // Yazma: Sadece admin
      allow create, update, delete: if isAdmin();
    }
    
    // Agreements collection
    match /agreements/{agreementId} {
      // Okuma: Authenticated kullanıcılar
      // Not: Frontend'de role-based filtering yapılacak
      allow read: if isAuthenticated();
      
      // Oluşturma ve güncelleme: Authenticated kullanıcılar
      allow create, update: if isAuthenticated();
      
      // Silme: Sadece admin
      allow delete: if isAdmin();
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Debts collection
    match /debts/{debtId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Checks collection
    match /checks/{checkId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Partners collection
    match /partners/{partnerId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Archived collections
    match /archivedSites/{siteId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedCompanies/{companyId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    match /archivedAgreements/{agreementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Logs collection
    match /logs/{logId} {
      // Şu an için loglar tüm istemciler için açık; gerekirse ileride tekrar sıkılaştırılabilir.
      allow read, create, update, delete: if true;
    }
    
    // Panel images metadata
    match /panelImages/{imageId} {
      // Admin ve personel tüm görselleri okuyabilir
      // Firma kullanıcısı: sadece kendi companyId'sine ait görselleri görebilir
      // Site kullanıcısı: sadece kendi siteId'sine ait görselleri görebilir
      allow get: if isAdmin() ||
                  isPersonnel() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId()) ||
                  (isSiteUser() && resource.data.siteId == getUserSiteId()) ||
                  (isAuthenticated() && 
                   request.auth.token.email != null && 
                   (request.auth.token.email.split('@')[1] == 'company.local' || 
                    request.auth.token.email.split('@')[1] == 'site.local'));

      // List: Admin, personel, firma ve site kullanıcıları tüm görselleri listeleyebilir
      // Frontend'de filtreleme yapılacak
      // Email kontrolü ile company ve site kullanıcılarına da izin ver
      allow list: if isAdmin() || 
                    isPersonnel() ||
                    isCompanyUser() ||
                    isSiteUser() ||
                    (isAuthenticated() && 
                     request.auth.token.email != null && 
                     (request.auth.token.email.split('@')[1] == 'company.local' || 
                      request.auth.token.email.split('@')[1] == 'site.local'));

      // Yazma: sadece admin ve personel
      allow create, update, delete: if isAdmin() || isPersonnel();
    }
    
    // Agreement documents metadata
    match /agreementDocuments/{docId} {
      // Admin tüm dokümanları görebilir
      // Firma kullanıcısı sadece kendi anlaşmalarına ait dokümanları görebilmeli
      allow get: if isAdmin() ||
                  (isCompanyUser() && resource.data.companyId == getUserCompanyId());

      allow list: if isAdmin();

      // Yazma: sadece admin
      allow create, update, delete: if isAdmin();
    }
    
    // Default: deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}