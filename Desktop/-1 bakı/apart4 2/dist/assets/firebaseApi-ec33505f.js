import{b1 as h}from"./index-8c9f38c9.js";import{l as L,g as b,a as $,b as A,c as R,d as D,u as N,e as T,f as O,h as V,i as k,j as x,k as U,m as q,n as E,o as z,p as F,q as Q,r as B,s as G,t as j,v as M,w as H,x as J,y as K,z as W,A as C,B as P,C as X,D as Y,E as Z,F as ee,G as te,H as se,I as re,J as ae,K as ne}from"./firebaseDb-cdf0b9a6.js";import{O as lt,N as ut,M as dt,L as mt}from"./firebaseDb-cdf0b9a6.js";import"./vendor-06819936.js";let v=!1;const s=async()=>{const{auth:e}=await h(()=>import("./index-8c9f38c9.js").then(t=>t.bs),["assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]);if(!e)return console.log("ðŸš« Firebase is disabled - using local mode"),!1;if(!v)try{await ne(),v=!0}catch(t){console.error("Firebase initialization error:",t),v=!0}return!0},le=async(e,t)=>{try{console.log("API login called with:",e);const{getDocument:r}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(i=>i.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),o=[];if(e.includes("@")){let i="admin";e.includes("@site.local")?i="site_user":e.includes("@company.local")?i="company":e.includes("@personnel.local")&&(i="personnel"),o.push({email:e,role:i})}else e.toLowerCase()==="admin"?(o.push({email:"admin@apartmecra.com",role:"admin"}),o.push({email:"admin@example.com",role:"admin"})):(o.push({email:`${e}@site.local`,role:"site_user"}),o.push({email:`${e}@company.local`,role:"company"}),o.push({email:`${e}@personnel.local`,role:"personnel"}));const l=[];for(const i of o){o.indexOf(i)===0&&console.log("Attempting login with email:",i.email,"role:",i.role);try{let d=null;if(i.role==="site_user"){const w=i.email.replace("@site.local","");let f=await r("sites",w);if(!f.success){const{collection:S,query:n,where:a,getDocs:u}=await h(()=>import("./index.esm-9f6d33f3.js"),["assets/index.esm-9f6d33f3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),{db:p}=await h(()=>import("./index-8c9f38c9.js").then(_=>_.bs),["assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),y=S(p,"sites"),c=n(y,a("id","==",w)),I=await u(c);if(!I.empty){const _=I.docs[0];f={success:!0,data:{id:_.id,..._.data()}}}}if(f.success){if(f.data.status==="archived")return console.log("Site user is archived, login denied:",w),{error:"Bu site arÅŸivlenmiÅŸ, giriÅŸ yapÄ±lamaz"};d=f.data}}let m=null;if(i.role==="company"){const w=i.email.replace("@company.local","");let f=await r("companies",w);if(!f.success){const{collection:S,query:n,where:a,getDocs:u}=await h(()=>import("./index.esm-9f6d33f3.js"),["assets/index.esm-9f6d33f3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),{db:p}=await h(()=>import("./index-8c9f38c9.js").then(_=>_.bs),["assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),y=S(p,"companies"),c=n(y,a("id","==",w)),I=await u(c);if(!I.empty){const _=I.docs[0];f={success:!0,data:{id:_.id,..._.data()}}}}if(f.success){if(f.data.status==="archived")return console.log("Company user is archived, login denied:",w),{error:"Bu firma arÅŸivlenmiÅŸ, giriÅŸ yapÄ±lamaz"};m=f.data}}const g=await L(i.email,t);if(g.success){console.log("API login successful with role:",i.role);const w={username:g.user.username,role:i.role,siteId:g.user.siteId||null,companyId:g.user.companyId||null,id:g.user.uid};return i.role==="company"&&m&&(w.name=m.name||m.id||g.user.username,w.id=m.id||g.user.uid),i.role==="site_user"&&d&&(w.name=d.name||d.id||g.user.username,w.id=d.id||g.user.uid),{token:g.token,user:w}}}catch(d){l.push({email:i.email,error:d.message});continue}}return l.length>0&&o.length===l.length&&console.error("All login attempts failed:",l),console.error("All login attempts failed"),{error:"GeÃ§ersiz kimlik bilgileri"}}catch(r){return console.error("API login error:",r),{error:"BaÄŸlantÄ± hatasÄ±: Sunucuya ulaÅŸÄ±lamÄ±yor"}}},ue=async(e,t)=>{try{if(!b())return{error:"No authenticated user"};const{updateUserPassword:o}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(i=>i.P),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),l=await o(t);return l.success?{success:!0}:{error:l.error}}catch{return{error:"Password change failed"}}},de=async()=>(await s(),await $()),me=async(e=5)=>(await s(),(await A()).slice(0,e)),ge=async()=>(await s(),await R()),we=async(e,t=null,r=null)=>{try{console.log("Creating site with data:",e),await s();const o=await D(e);if(console.log("Create site result:",o),o.success)return o.data;throw new Error(o.error||"Site creation failed")}catch(o){throw console.error("Error in createSite:",o),o}},pe=async(e,t)=>{await s();const r=await N(e,t);return r.success?r.data:null},ye=async e=>(await s(),(await T(e)).success),fe=async e=>(await s(),await O(e)),he=async()=>(await s(),await V()),_e=async e=>{await s();const t=await k(e);return t.success?t.data:null},Ie=async(e,t)=>{await s();const r=await x(e,t);if(r.success)return r.data;throw console.error("updateCompany failed:",r.error),new Error(r.error||"Company update failed")},Se=async e=>(await s(),(await U(e)).success),Ae=async e=>(await s(),await q(e)),Ee=async()=>(await s(),await E()),ve=async e=>{await s();const t=await z(e);return t.success?t.data:null},Ce=async(e,t)=>{await s();const r=await F(e,t);return r.success?r.data:null},Pe=async e=>(await s(),(await Q(e)).success),Le=async e=>(await s(),await B(e)),be=async()=>(await s(),await A()),$e=async e=>{await s();const t=await G(e);return t.success?t.data:null},Re=async(e,t)=>{await s();const r=await j(e,t);return r.success?r.data:null},De=async e=>(await s(),(await M(e)).success),Ne=async()=>(await s(),await H()),Te=async e=>{await s();const t=await J(e);return t.success?t.data:null},Oe=async(e,t)=>{await s();const r=await K(e,t);return r.success?r.data:null},Ve=async e=>(await s(),(await W(e)).success),ke=async()=>(await s(),(await C("archivedSites",[],"archivedAt","desc")).data||[]),xe=async()=>(await s(),(await C("archivedCompanies",[],"archivedAt","desc")).data||[]),Ue=async()=>(await s(),(await C("archivedAgreements",[],"archivedAt","desc")).data||[]),qe=async e=>(await s(),(await P("archivedSites",e)).success),ze=async e=>(await s(),(await P("archivedCompanies",e)).success),Fe=async e=>(await s(),(await P("archivedAgreements",e)).success),Qe=async e=>{await s();const{restoreSite:t}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(o=>o.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]);return(await t(e)).success||!1},Be=async e=>{await s();const{restoreCompany:t}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(o=>o.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]);return(await t(e)).success||!1},Ge=async e=>{await s();try{const{getDocument:t,createDocument:r,deleteDocument:o}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(m=>m.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),l=await t("archivedAgreements",e);if(!l.success)return!1;const i=l.data;return delete i.status,delete i.archivedAt,(await r("agreements",i)).success?(await o("archivedAgreements",e),!0):!1}catch(t){return console.error("Error restoring agreement:",t),!1}},je=async()=>(await s(),await X()),Me=async e=>{if(await s(),e.role==="personnel"&&e.username&&e.password)return await Y(e.username,e.password,e);throw console.error("createUser: Only personnel users can be created from frontend. Requested role:",e.role),new Error("Sadece personel kullanÄ±cÄ±larÄ± bu ekrandan oluÅŸturulabilir. Firma ve Site kullanÄ±cÄ±larÄ± otomatik olarak eklenir.")},He=async(e,t)=>{await s();const r=await updateUserInDb(e,t);return r.success?r.data:null},Je=async e=>(await s(),(await Z(e)).success),Ke=async e=>{await s();try{if(!e)return console.error("getSiteData: siteId is null or undefined"),{site:null,agreements:[],transactions:[]};const{getDocument:t,getCollection:r}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(n=>n.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),[o,l,i,d]=await Promise.all([t("sites",e),r("sites"),E(),A()]);let m=null;if(o.success&&o.data)m=o.data;else if(l.success&&l.data){const n=String(e).trim();m=l.data.find(a=>{const u=a.id?String(a.id).trim():"",p=a.siteId?String(a.siteId).trim():"",y=a._docId?String(a._docId).trim():"";if(u===n||p===n||y===n||u.toLowerCase()===n.toLowerCase()||p.toLowerCase()===n.toLowerCase()||y.toLowerCase()===n.toLowerCase())return!0;const c=Number(n);if(!isNaN(c)){const I=Number(a.id),_=Number(a.siteId);if(!isNaN(I)&&I===c||!isNaN(_)&&_===c)return!0}return!1})}if(!m){if(console.error("getSiteData: Site not found for siteId:",e),l.success&&l.data&&l.data.length>0){console.error("getSiteData: Available sites in database (total:",l.data.length,"):"),l.data.forEach((a,u)=>{console.error(`  [${u}] id: "${a.id}", siteId: "${a.siteId}", _docId: "${a._docId}", name: "${a.name}"`)});const n=l.data.filter(a=>{const u=String(a.id||""),p=String(a.siteId||""),y=String(a._docId||""),c=String(e);return u===c||p===c||y===c||u.toLowerCase()===c.toLowerCase()||p.toLowerCase()===c.toLowerCase()||y.toLowerCase()===c.toLowerCase()});if(n.length>0)console.warn("getSiteData: Found exact or case-insensitive matches:",n.map(a=>({id:a.id,siteId:a.siteId,_docId:a._docId,name:a.name})));else{console.warn('getSiteData: No exact match found. Searching for sites containing "yak34"...');const a=l.data.filter(u=>{const p=String(u.id||"").toLowerCase(),y=String(u.siteId||"").toLowerCase(),c=String(e).toLowerCase();return p.includes(c)&&c.length>=3||y.includes(c)&&c.length>=3||c.includes(p)&&p.length>=3||c.includes(y)&&y.length>=3});a.length>0&&a.length<=5&&console.warn("getSiteData: Found partial matches (showing max 5):",a.map(u=>({id:u.id,siteId:u.siteId,_docId:u._docId,name:u.name})))}}else console.error("getSiteData: No sites found in database at all!");return{site:null,agreements:[],transactions:[]}}const g=new Set;[e,m.id,m.siteId,m._docId].forEach(n=>{if(n!=null&&n!==void 0){g.add(n),g.add(String(n)),g.add(String(n).toLowerCase()),g.add(String(n).toUpperCase());const a=Number(n);isNaN(a)||g.add(a)}});const w=Array.from(g),f=i.filter(n=>!n.siteIds||!Array.isArray(n.siteIds)?!1:n.siteIds.some(a=>{const u=String(a);return w.some(p=>{const y=String(p);if(u===y||u.toLowerCase()===y.toLowerCase())return!0;const c=Number(a),I=Number(p);return!isNaN(c)&&!isNaN(I)&&c===I})})),S=d.filter(n=>{var a,u,p;return n.type==="expense"&&((a=n.source)==null?void 0:a.includes("Site Ã–demesi"))&&((u=n.source)==null?void 0:u.includes(m.name))||n.type==="income"&&((p=n.source)==null?void 0:p.includes("AnlaÅŸma Ã–demesi"))&&f.some(y=>{var c;return(c=n.source)==null?void 0:c.includes(y.id)})});return{site:m,agreements:f,transactions:S}}catch(t){return console.error("Error fetching site data:",t),{site:null,agreements:[],transactions:[]}}},We=async e=>(await s(),(await E()).filter(r=>r.siteIds&&r.siteIds.includes(e))),Xe=async e=>{await s();try{const{getDocument:t}=await h(()=>import("./firebaseDb-cdf0b9a6.js").then(d=>d.Q),["assets/firebaseDb-cdf0b9a6.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),[r,o,l]=await Promise.all([A(),t("sites",e),E()]);if(!o.success)return[];const i=l.filter(d=>d.siteIds&&d.siteIds.includes(e));return r.filter(d=>{var m,g,w;return d.type==="expense"&&((m=d.source)==null?void 0:m.includes("Site Ã–demesi"))&&((g=d.source)==null?void 0:g.includes(o.data.name))||d.type==="income"&&((w=d.source)==null?void 0:w.includes("AnlaÅŸma Ã–demesi"))&&i.some(f=>{var S;return(S=d.source)==null?void 0:S.includes(f.id)})})}catch(t){return console.error("Error fetching site transactions:",t),[]}},Ye=async()=>(await s(),await ee()),Ze=async e=>{await s();const t=await te(e);return t.success?t.data:null},et=async e=>(await s(),(await se(e)).success),tt=async(e={})=>{try{const{getPanelImages:t}=await h(()=>import("./firebaseStorage-c6464fa3.js"),["assets/firebaseStorage-c6464fa3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),r=await t(e);return console.log("getPanelImages called - returning images:",r.data),r.data||[]}catch(t){return console.error("Error fetching panel images:",t),[]}},st=async e=>{try{const{uploadPanelImage:t}=await h(()=>import("./firebaseStorage-c6464fa3.js"),["assets/firebaseStorage-c6464fa3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),r=e.get("agreementId"),o=e.get("siteId"),l=e.get("blockId"),i=e.get("panelId"),d=e.get("companyId"),m=e.get("image");if(!m)throw new Error("Image file is missing");const w=await t(m,{agreementId:r,siteId:o,blockId:l,panelId:i,companyId:d});return console.log("uploadPanelImage called - returning result:",w),w}catch(t){throw console.error("Error uploading panel image:",t),t}},rt=async()=>{try{const{cleanupExpiredImages:e}=await h(()=>import("./firebaseStorage-c6464fa3.js"),["assets/firebaseStorage-c6464fa3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),t=await e();return console.log("cleanupExpiredImages called - result:",t),t}catch(e){return console.error("Error cleaning up expired images:",e),{success:!1,error:e.message}}},at=async()=>{try{const{resetAllPanelImages:e}=await h(()=>import("./firebaseStorage-c6464fa3.js"),["assets/firebaseStorage-c6464fa3.js","assets/index-8c9f38c9.js","assets/vendor-06819936.js","assets/index-14ec5823.css"]),t=await e();return console.log("resetPanelImages called - result:",t),t}catch(e){return console.error("Error resetting panel images:",e),{success:!1,error:e.message}}},nt=async()=>(await s(),await re()),ot=async e=>(await s(),await ae(e));export{Le as archiveAgreement,Ae as archiveCompany,fe as archiveSite,lt as canAccessCompany,ut as canAccessSite,ue as changePassword,rt as cleanupExpiredImages,ot as createAccountingRecord,ve as createAgreement,_e as createCompany,Ze as createLog,Te as createPartner,we as createSite,$e as createTransaction,Me as createUser,Pe as deleteAgreement,Fe as deleteArchivedAgreement,ze as deleteArchivedCompany,qe as deleteArchivedSite,Se as deleteCompany,et as deleteLog,Ve as deletePartner,ye as deleteSite,De as deleteTransaction,Je as deleteUser,nt as getAccountingRecords,Ee as getAgreements,Ue as getArchivedAgreements,xe as getArchivedCompanies,ke as getArchivedSites,he as getCompanies,b as getCurrentUser,de as getDashboardSummary,Ye as getLogs,tt as getPanelImages,Ne as getPartners,me as getRecentTransactions,We as getSiteAgreements,Ke as getSiteData,Xe as getSiteTransactions,ge as getSites,be as getTransactions,je as getUsers,dt as hasPermission,le as login,mt as onAuthStateChange,at as resetPanelImages,Ge as restoreAgreement,Be as restoreCompany,Qe as restoreSite,Ce as updateAgreement,Ie as updateCompany,Oe as updatePartner,pe as updateSite,Re as updateTransaction,He as updateUser,st as uploadPanelImage};
